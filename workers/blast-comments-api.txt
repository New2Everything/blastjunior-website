export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    // CORS preflight
    if (request.method === "OPTIONS") {
      return new Response(null, { status: 204, headers: corsHeaders() });
    }

    // 兼容被路由到 /comments/* 的情况
    const path = normalizePath(url.pathname, ["/comments"]);

    try {
      // Public: list approved comments for a photo
      // GET /comments?photoId=90
      if (request.method === "GET" && (path === "/" || path === "/comments")) {
        return withCors(await handleListComments(env, url.searchParams));
      }

      // Public: create comment (pending)
      // POST /comments  body: { photoId, content, nickname?, region? }
      if (request.method === "POST" && (path === "/" || path === "/comments")) {
        return withCors(await handleCreateComment(request, env));
      }

      // Admin: list by status
      // GET /admin/comments?status=pending
      if (
        request.method === "GET" &&
        (path === "/admin/comments" || path === "/admin/list" || path === "/admin/comments/list")
      ) {
        return withCors(await adminListComments(request, env, url.searchParams));
      }

      // Admin: actions
      // POST /admin/comments/approve|reject|delete  body:{id}
      if (request.method === "POST" && path.startsWith("/admin/comments")) {
        return withCors(await adminAction(request, env, path));
      }

      return withCors(jsonResponse({ ok: false, error: "Not found", path }, 404));
    } catch (err) {
      return withCors(
        jsonResponse({ ok: false, error: "Worker error", detail: String(err?.message || err) }, 500)
      );
    }
  },
};

// ---------- helpers ----------
function corsHeaders() {
  return {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, X-Admin-Token",
  };
}
function withCors(resp) {
  const h = new Headers(resp.headers);
  const ch = corsHeaders();
  for (const [k, v] of Object.entries(ch)) h.set(k, v);
  return new Response(resp.body, { status: resp.status, headers: h });
}
function jsonResponse(data, status = 200) {
  return new Response(JSON.stringify(data, null, 2), {
    status,
    headers: { "Content-Type": "application/json; charset=utf-8" },
  });
}
function normalizePath(pathname, prefixes = []) {
  for (const p of prefixes) {
    if (pathname === p) return "/";
    if (pathname.startsWith(p + "/")) return pathname.slice(p.length);
  }
  return pathname;
}
function charLen(s) {
  return Array.from(s || "").length;
}
function getAdminToken(request, searchParams, bodyToken) {
  const h = request.headers.get("X-Admin-Token") || "";
  const q = searchParams?.get("token") || "";
  return (h || q || bodyToken || "").trim();
}
function requireAdmin(env, token) {
  if (!env.ADMIN_TOKEN) {
    return { ok: false, resp: jsonResponse({ ok: false, error: "ADMIN_TOKEN not set in Worker env" }, 500) };
  }
  if (token !== env.ADMIN_TOKEN) {
    return { ok: false, resp: jsonResponse({ ok: false, error: "Unauthorized" }, 401) };
  }
  return { ok: true };
}
function mapRowToItem(r) {
  return {
    id: r.id,
    photoId: String(r.photo_id),
    content: r.content,
    status: r.status,
    source: r.source,
    region: r.region || "某地",
    nickname: r.nickname || "",
    createdAt: r.created_at,
    updatedAt: r.updated_at,
  };
}

// ---------- business (D1) ----------
async function handleCreateComment(request, env) {
  if (!env.DB) return jsonResponse({ ok: false, error: "D1 binding DB missing" }, 500);

  let body = {};
  try {
    body = await request.json();
  } catch {
    return jsonResponse({ ok: false, error: "Invalid JSON" }, 400);
  }

  const photoIdRaw = (body.photoId || body.photo_id || "").toString().trim();
  const photoId = parseInt(photoIdRaw, 10);
  let content = (body.content || "").toString().trim();
  const nickname = (body.nickname || "").toString().trim().slice(0, 32) || null;
  const region = (body.region || "").toString().trim().slice(0, 32) || null;

  if (!Number.isFinite(photoId) || photoId <= 0) {
    return jsonResponse({ ok: false, error: "photoId required (number)" }, 400);
  }
  if (!content) return jsonResponse({ ok: false, error: "content required" }, 400);

  // 和你页面提示对齐：20~120 字为宜（这里硬限制 300，避免太死）
  const len = charLen(content);
  if (len < 4) return jsonResponse({ ok: false, error: "留言太短（至少4字）" }, 400);
  if (len > 300) return jsonResponse({ ok: false, error: "留言最多300字" }, 400);

  const now = new Date().toISOString();

  const stmt = env.DB.prepare(`
    INSERT INTO comments (photo_id, content, status, source, nickname, region, created_at, updated_at)
    VALUES (?1, ?2, 'pending', 'viewer', ?3, ?4, ?5, ?6)
  `);

  const res = await stmt.bind(photoId, content, nickname, region, now, now).run();

  return jsonResponse({
    ok: true,
    item: {
      id: res.meta.last_row_id,
      photoId: String(photoId),
      content,
      status: "pending",
      createdAt: now,
      region: region || "某地",
    },
  });
}

async function handleListComments(env, searchParams) {
  if (!env.DB) return jsonResponse({ ok: false, error: "D1 binding DB missing" }, 500);

  const photoIdRaw = (searchParams.get("photoId") || searchParams.get("photo_id") || "").trim();
  const photoId = parseInt(photoIdRaw, 10);

  if (!Number.isFinite(photoId) || photoId <= 0) {
    return jsonResponse({ ok: false, error: "photoId required" }, 400);
  }

  // 公共接口：默认只给 approved
  const stmt = env.DB.prepare(`
    SELECT id, photo_id, content, status, source, nickname, region, created_at, updated_at
    FROM comments
    WHERE photo_id = ?1 AND status = 'approved'
    ORDER BY created_at DESC
    LIMIT 200
  `);

  const rows = await stmt.bind(photoId).all();
  const items = (rows.results || []).map(mapRowToItem);

  return jsonResponse({ ok: true, count: items.length, items });
}

async function adminListComments(request, env, searchParams) {
  if (!env.DB) return jsonResponse({ ok: false, error: "D1 binding DB missing" }, 500);

  const token = getAdminToken(request, searchParams);
  const gate = requireAdmin(env, token);
  if (!gate.ok) return gate.resp;

  const status = (searchParams.get("status") || "pending").trim();
  const limit = Math.min(parseInt(searchParams.get("limit") || "200", 10) || 200, 500);

  const stmt = env.DB.prepare(`
    SELECT id, photo_id, content, status, source, nickname, region, created_at, updated_at
    FROM comments
    WHERE status = ?1
    ORDER BY created_at DESC
    LIMIT ?2
  `);

  const rows = await stmt.bind(status, limit).all();
  const items = (rows.results || []).map(mapRowToItem);

  return jsonResponse({ ok: true, count: items.length, items });
}

async function adminAction(request, env, path) {
  if (!env.DB) return jsonResponse({ ok: false, error: "D1 binding DB missing" }, 500);

  let body = {};
  try {
    body = await request.json();
  } catch {
    body = {};
  }

  const sp = new URL(request.url).searchParams;
  const token = getAdminToken(request, sp, body.token);
  const gate = requireAdmin(env, token);
  if (!gate.ok) return gate.resp;

  const id = parseInt((body.id || "").toString().trim(), 10);
  if (!Number.isFinite(id) || id <= 0) return jsonResponse({ ok: false, error: "id required" }, 400);

  let action = (body.action || "").toString().trim().toLowerCase();
  if (!action) {
    if (path.endsWith("/approve")) action = "approve";
    else if (path.endsWith("/reject")) action = "reject";
    else if (path.endsWith("/delete")) action = "delete";
    else action = "approve";
  }

  const now = new Date().toISOString();

  if (action === "approve") {
    await env.DB.prepare(`UPDATE comments SET status='approved', updated_at=?2 WHERE id=?1`)
      .bind(id, now)
      .run();
  } else if (action === "reject" || action === "deny") {
    await env.DB.prepare(`UPDATE comments SET status='rejected', updated_at=?2 WHERE id=?1`)
      .bind(id, now)
      .run();
  } else if (action === "delete" || action === "remove") {
    await env.DB.prepare(`DELETE FROM comments WHERE id=?1`).bind(id).run();
    return jsonResponse({ ok: true, deleted: true, id });
  } else {
    return jsonResponse({ ok: false, error: "Invalid action" }, 400);
  }

  const row = await env.DB.prepare(`
    SELECT id, photo_id, content, status, source, nickname, region, created_at, updated_at
    FROM comments WHERE id=?1
  `).bind(id).first();

  if (!row) return jsonResponse({ ok: false, error: "Not found" }, 404);
  return jsonResponse({ ok: true, item: mapRowToItem(row) });
}
