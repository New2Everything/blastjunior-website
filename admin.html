<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>管理后台</title>
  <style>
    body { font-family: system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; margin: 24px; background:#f6f7fb;}
    h1 { margin: 0 0 8px; font-size: 40px; }
    .sub { color:#666; margin-bottom: 18px; }

    .tabs { display:flex; gap:10px; margin-bottom:16px; }
    .tab { padding:8px 14px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer;}
    .tab.active { background:#2563eb; color:#fff; border-color:#2563eb;}

    .bar { display:flex; gap:10px; align-items:center; margin: 14px 0 18px; }
    input, select, textarea {
      padding: 10px 12px; border-radius: 10px; border:1px solid #ddd;
      font-family: inherit;
    }
    input { width: 360px; }
    textarea { width:100%; min-height:120px; }
    button { padding: 10px 14px; border-radius: 10px; border:1px solid #ddd; background:#fff; cursor:pointer;}
    button.primary { background:#2563eb; color:#fff; border-color:#2563eb;}
    button.ok { background:#16a34a; color:#fff; border-color:#16a34a;}
    button.warn { background:#f59e0b; color:#fff; border-color:#f59e0b;}

    .grid { display:grid; grid-template-columns: 1fr; gap: 14px; }
    .card { background:#fff; border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.06); padding: 14px; }
    .card h3 { margin:0 0 10px; }

    .row { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
    .row label { width:160px; color:#555; }

    pre { background:#0b1220; color:#e5e7eb; padding: 12px; border-radius: 12px; overflow:auto; }
    .muted { color:#777; font-size:13px; }
  </style>
</head>
<body>

<h1>管理后台</h1>
<div class="sub">媒体审核 & Writer Worker 控制台</div>

<!-- ========== Tabs ========== -->
<div class="tabs">
  <div class="tab active" id="tab-media">媒体审核</div>
  <div class="tab" id="tab-writer">Writer Console</div>
</div>

<!-- ========== Token Bar ========== -->
<div class="bar">
  <div>管理员口令：</div>
  <input id="token" type="password" placeholder="输入 ADMIN_TOKEN" />
  <button id="save">保存到本机</button>
  <button id="load">本机记忆</button>
</div>

<!-- ========== Media Panel (原功能，几乎未动) ========== -->
<div id="panel-media">
  <div class="bar">
    <button id="refresh" class="primary">刷新待审核</button>
    <div id="count" style="color:#666;"></div>
  </div>
  <div id="out"></div>
  <div class="grid" id="list"></div>
</div>

<!-- ========== Writer Panel ========== -->
<div id="panel-writer" style="display:none;">
  <div class="card">
    <h3>Writer Worker</h3>

    <div class="row">
      <label>Worker URL</label>
      <input id="writerUrl" value="https://writerworker.kanjiaming2022.workers.dev" />
    </div>

    <div class="row">
      <label>Action</label>
      <select id="actionSelect"></select>
    </div>

    <div class="row">
      <label>说明</label>
      <div id="actionDesc" class="muted"></div>
    </div>

    <div class="row">
      <label>Payload（JSON）</label>
    </div>
    <textarea id="payload"></textarea>

    <div class="row">
      <button class="warn" id="btnDry">Dry-Run（校验）</button>
      <button class="ok" id="btnReal" disabled>Real-Run（执行）</button>
    </div>

    <div id="writerOut"></div>
  </div>
</div>

<script>
/* ================== Utils ================== */
const $ = id => document.getElementById(id);
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function showOut(el, obj){
  el.innerHTML = "<pre>"+escapeHtml(JSON.stringify(obj,null,2))+"</pre>";
}

/* ================== Token ================== */
$("save").onclick = ()=>{
  localStorage.setItem("admin_token", $("token").value || "");
  alert("已保存");
};
$("load").onclick = ()=>{
  $("token").value = localStorage.getItem("admin_token") || "";
  alert("已载入");
};
$("load").click();

/* ================== Tabs ================== */
function switchTab(name){
  $("tab-media").classList.toggle("active", name==="media");
  $("tab-writer").classList.toggle("active", name==="writer");
  $("panel-media").style.display = name==="media"?"block":"none";
  $("panel-writer").style.display = name==="writer"?"block":"none";
}
$("tab-media").onclick = ()=>switchTab("media");
$("tab-writer").onclick = ()=>switchTab("writer");

/* ================== Media (原逻辑) ================== */
const outEl = $("out"), listEl = $("list"), countEl = $("count");
$("refresh").onclick = ()=>loadList();

function authHeaders(){
  const t = ($("token").value||"").trim();
  return t ? {"Authorization":"Bearer "+t}:{};
}

async function loadList(){
  outEl.innerHTML=""; listEl.innerHTML=""; countEl.textContent="";
  if (!($("token").value||"").trim()) return;
  const r = await fetch("/media/admin/list",{headers:{...authHeaders()}});
  const j = await r.json(); showOut(outEl,j);
  if (!j.ok) return;
  const items=j.items||[]; countEl.textContent=`待审核：${items.length}`;
  for (const it of items) listEl.appendChild(renderCard(it));
}

function renderCard(it){
  const d=document.createElement("div"); d.className="card";
  d.innerHTML=`<div><b>${escapeHtml(it.upload_id)}</b></div>`;
  return d;
}
loadList();

/* ================== Writer Console ================== */
const ACTIONS = {
  "events.create": "创建赛事",
  "events.update": "更新赛事",
  "teams.create": "创建队伍",
  "teams.update": "更新队伍",
  "players.create": "创建选手",
  "players.update": "更新选手",
  "registrations.create": "创建报名",
  "rosters.add": "添加阵容",
  "team_component_points.upsert": "写入积分"
};

const actionSelect = $("actionSelect");
const actionDesc = $("actionDesc");
const payloadEl = $("payload");
const outWriter = $("writerOut");
let lastDryHash = null;

for (const k in ACTIONS){
  const o=document.createElement("option");
  o.value=k; o.textContent=k;
  actionSelect.appendChild(o);
}

function updateAction(){
  actionDesc.textContent = ACTIONS[actionSelect.value] || "";
  payloadEl.value = JSON.stringify({
    // 示例 payload
    items: [
      { /* 填写字段 */ }
    ]
  }, null, 2);
  $("btnReal").disabled = true;
}
actionSelect.onchange = updateAction;
updateAction();

function hash(str){ return btoa(unescape(encodeURIComponent(str))).slice(0,20); }

async function send(mode){
  const token = ($("token").value||"").trim();
  if (!token) { alert("请先输入 ADMIN_TOKEN"); return; }

  let payload;
  try { payload = JSON.parse(payloadEl.value); }
  catch { alert("JSON 格式错误"); return; }

  payload.token = token;
  payload.mode = mode;
  payload.action = actionSelect.value;

  const r = await fetch($("writerUrl").value,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const j = await r.json();
  showOut(outWriter,j);

  if (mode==="dry-run"){
    if (j.ok){
      lastDryHash = hash(payloadEl.value);
      $("btnReal").disabled = false;
    } else {
      $("btnReal").disabled = true;
    }
  } else {
    $("btnReal").disabled = true;
  }
}

$("btnDry").onclick = ()=>send("dry-run");
$("btnReal").onclick = ()=>{
  if (hash(payloadEl.value)!==lastDryHash){
    alert("Payload 已变更，请重新 dry-run");
    return;
  }
  send("single");
};
</script>
</body>
</html>
