<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>媒体审核后台</title>
  <style>
    body { font-family: system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; margin: 24px; background:#f6f7fb;}
    h1 { margin: 0 0 8px; font-size: 40px; }
    .sub { color:#666; margin-bottom: 18px; }
    .bar { display:flex; gap:10px; align-items:center; margin: 14px 0 18px; }
    input { width: 360px; padding: 10px 12px; border-radius: 10px; border:1px solid #ddd; }
    button { padding: 10px 14px; border-radius: 10px; border:1px solid #ddd; background:#fff; cursor:pointer;}
    button.primary { background:#2563eb; color:#fff; border-color:#2563eb;}
    .grid { display:grid; grid-template-columns: 1fr; gap: 14px; }
    .card { background:#fff; border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.06); padding: 14px; display:grid; grid-template-columns: 280px 1fr; gap:14px; }
    .thumb { width: 280px; height: 280px; border-radius: 14px; background:#f0f0f0; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .meta { color:#333; }
    .meta .id { font-weight: 800; font-size: 18px; margin-bottom: 6px; }
    .meta .line { color:#666; margin: 4px 0; }
    .actions { margin-top: 10px; display:flex; gap:10px; }
    .ok { background:#16a34a; color:#fff; border-color:#16a34a;}
    .bad { background:#ef4444; color:#fff; border-color:#ef4444;}
    pre { background:#0b1220; color:#e5e7eb; padding: 12px; border-radius: 12px; overflow:auto; }
  </style>
</head>
<body>
  <h1>媒体审核后台</h1>
  <div class="sub">照片审核走 <code>/media</code>（pending → approve/deny）。approve 后只生成 <code>web/</code> 和 <code>thumb/</code>。</div>

  <div class="bar">
    <div>管理员口令：</div>
    <input id="token" type="password" placeholder="输入 ADMIN_TOKEN" />
    <button id="save">保存到本机</button>
    <button id="load">本机记忆</button>
    <button id="refresh" class="primary">刷新待审核</button>
    <div id="count" style="color:#666;"></div>
  </div>

  <div id="out"></div>
  <div class="grid" id="list"></div>

<script>
  const $ = (id)=>document.getElementById(id);
  const tokenEl = $("token");
  const outEl = $("out");
  const listEl = $("list");
  const countEl = $("count");
window.INTERNAL_TOKEN = "Huangqing1";

  $("save").onclick = ()=> {
    localStorage.setItem("admin_token", tokenEl.value || "");
    alert("已保存");
  };
  $("load").onclick = ()=> {
    tokenEl.value = localStorage.getItem("admin_token") || "";
    alert("已载入");
  };
  $("refresh").onclick = ()=> loadList();

  function authHeaders() {
    const t = tokenEl.value || "";
    return t ? { "Authorization": "Bearer " + t } : {};
  }

  function showOut(obj) {
    outEl.innerHTML = "<pre>"+escapeHtml(JSON.stringify(obj, null, 2))+"</pre>";
  }

  async function loadList() {
    outEl.innerHTML = "";
    listEl.innerHTML = "";
    countEl.textContent = "";

    const r = await fetch("/media/admin/list", { headers: { ...authHeaders() } });
    const j = await r.json();
    showOut(j);
    if (!j.ok) return;

    const items = j.items || [];
    countEl.textContent = `待审核：${items.length}`;
    if (!items.length) return;

    for (const it of items) {
      listEl.appendChild(renderCard(it));
    }
  }

  function renderCard(it) {
    const card = document.createElement("div");
    card.className = "card";

    const thumb = document.createElement("div");
    thumb.className = "thumb";

    const img = document.createElement("img");
    img.alt = "preview";
    img.src =
  `/media/admin/preview/${encodeURIComponent(item.upload_id)}`
  + `?t=${encodeURIComponent(window.INTERNAL_TOKEN)}`;

    thumb.appendChild(img);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `
      <div class="id">${escapeHtml(it.upload_id)}</div>
      <div class="line">note：${escapeHtml(it.note || "")}</div>
      <div class="line">createdAt：${escapeHtml(it.created_at || "")}</div>
      <div class="line">status：${escapeHtml(it.status || "")}</div>
      <div class="line">预览接口：<code>/media/admin/preview/${escapeHtml(it.upload_id)}</code></div>
    `;

    const actions = document.createElement("div");
    actions.className = "actions";

    const okBtn = document.createElement("button");
    okBtn.className = "ok";
    okBtn.textContent = "通过";
    okBtn.onclick = ()=>approve(it.upload_id);

    const badBtn = document.createElement("button");
    badBtn.className = "bad";
    badBtn.textContent = "拒绝";
    badBtn.onclick = ()=>deny(it.upload_id);

    actions.appendChild(okBtn);
    actions.appendChild(badBtn);
    meta.appendChild(actions);

    card.appendChild(thumb);
    card.appendChild(meta);
    return card;
  }

  async function approve(receipt) {
    if (!confirm(`确认通过：${receipt} ?`)) return;
    const r = await fetch(`/media/admin/approve/${encodeURIComponent(receipt)}`, {
      method: "POST",
      headers: { ...authHeaders() }
    });
    const j = await r.json();
    alert(j.ok
      ? `已通过：photoId=${j.photoId}\nphotoKey=${j.photoKey}\nweb=${j.web}\nthumb=${j.thumb}`
      : `失败：${j.error || "unknown"}`
    );
    await loadList();
  }

  async function deny(receipt) {
    if (!confirm(`确认拒绝并删除：${receipt} ?`)) return;
    const r = await fetch(`/media/admin/deny/${encodeURIComponent(receipt)}`, {
      method: "POST",
      headers: { ...authHeaders() }
    });
    const j = await r.json();
    alert(j.ok ? "已拒绝" : `失败：${j.error || "unknown"}`);
    await loadList();
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  loadList();
</script>
</body>
</html>
