<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åª’ä½“å®¡æ ¸åå° - å…°æ˜Ÿå°‘å¹´ä¿±ä¹éƒ¨</title>
  <style>
    :root { --blue:#2563eb; --gray:#6b7280; --bg:#f6f7fb; --card:#fff; --bd:#e5e7eb; }
    body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      margin:0; background:var(--bg); color:#111827; }
    .wrap{ max-width:1100px; margin:28px auto; padding:0 16px; }
    h1{ margin:0 0 10px; font-size:40px; }
    .hint{ color:var(--gray); margin:0 0 16px; line-height:1.5; }
    .tabs{ display:flex; gap:10px; margin:16px 0; }
    .tabbtn{
      border:1px solid var(--bd); background:#fff; padding:10px 14px; border-radius:12px; cursor:pointer;
      display:flex; align-items:center; gap:8px; font-size:16px;
    }
    .tabbtn.active{ outline:2px solid rgba(37,99,235,.25); border-color:rgba(37,99,235,.45); }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:16px; padding:16px; }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .input{ border:1px solid var(--bd); border-radius:12px; padding:10px 12px; min-width:280px; font-size:16px; }
    .btn{ background:var(--blue); color:#fff; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; font-size:16px; }
    .btn.ghost{ background:#fff; color:#111827; border:1px solid var(--bd); }
    .btn.danger{ background:#ef4444; }
    .pill{ border:1px solid var(--bd); padding:6px 10px; border-radius:999px; color:#111827; background:#fff; }
    .list{ display:flex; flex-direction:column; gap:12px; margin-top:14px; }
    .item{ border:1px solid var(--bd); border-radius:14px; padding:12px; background:#fff; }
    .itemhead{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .muted{ color:var(--gray); }
    pre{ background:#0b1220; color:#e5e7eb; padding:14px; border-radius:14px; overflow:auto; }
    img{ max-width:240px; border-radius:12px; border:1px solid var(--bd); background:#fff; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 900px){ .grid2{ grid-template-columns:1fr; } img{ max-width:100%; } }
  </style>
</head>
<body>
<div class="wrap">
  <h1>åª’ä½“å®¡æ ¸åå°</h1>
  <p class="hint">
    - æŠ¥å/ç”³è¯·å®¡æ ¸èµ° <span class="mono">/forms</span>ï¼ˆåŸ contact-form-handlerï¼‰ï¼›
    è¯„è®ºå®¡æ ¸èµ° <span class="mono">/comments</span>ï¼ˆåŸ blast-comments-apiï¼‰ï¼›
    ç…§ç‰‡å®¡æ ¸èµ° <span class="mono">/media</span>ï¼ˆæ–°å¢ï¼‰ã€‚
  </p>

  <div class="tabs">
    <button class="tabbtn active" data-tab="photo">ğŸ“· ç…§ç‰‡å®¡æ ¸</button>
    <button class="tabbtn" data-tab="forms">ğŸ“ æŠ¥å/ç”³è¯·å®¡æ ¸</button>
    <button class="tabbtn" data-tab="comments">ğŸ’¬ è¯„è®ºå®¡æ ¸</button>
  </div>

  <!-- é€šç”¨ Token -->
  <div class="card">
    <div class="row">
      <div><b>ç®¡ç†å‘˜å£ä»¤ï¼š</b></div>
      <input id="token" class="input" type="password" placeholder="ADMIN_TOKEN / X-Admin-Token" />
      <button class="btn ghost" id="btnSave">ä¿å­˜åˆ°æœ¬æœº</button>
      <span class="pill">æœ¬æœºè®°å¿†</span>
    </div>
  </div>

  <div style="height:14px;"></div>

  <!-- ç…§ç‰‡å®¡æ ¸ -->
  <div id="tab-photo" class="card">
    <h2 style="margin:0 0 8px;">ç…§ç‰‡å®¡æ ¸ï¼ˆæ¥è‡ª /media/uploadï¼‰</h2>
    <p class="hint" style="margin-top:0;">
      å¾…å®¡æ ¸åœ¨ R2 çš„ <span class="mono">pending/</span>ï¼Œé€šè¿‡åå‘å¸ƒåˆ° <span class="mono">public/HADO(xxx).jpg</span> å¹¶å¯ç”¨
      <span class="mono">/media/public/HADO(xxx).jpg</span> è®¿é—®ã€‚
    </p>

    <div class="row">
      <button class="btn" id="btnPhotoRefresh">åˆ·æ–°å¾…å®¡æ ¸</button>
      <span class="pill">å¾…å®¡æ ¸ï¼š<span id="photoCount">0</span></span>
    </div>

    <div id="photoList" class="list"></div>

    <div class="hint" style="margin-top:12px;">è°ƒè¯•è¾“å‡ºï¼š</div>
    <pre id="photoDebug">{}</pre>
  </div>

  <!-- æŠ¥åå®¡æ ¸ -->
  <div id="tab-forms" class="card" style="display:none;">
    <h2 style="margin:0 0 8px;">æŠ¥å/ç”³è¯·å®¡æ ¸ï¼ˆåŸåŠŸèƒ½ä¿ç•™ï¼‰</h2>
    <p class="hint" style="margin-top:0;">ç»§ç»­è°ƒç”¨ä½ çš„ <span class="mono">contact-form-handler</span>ï¼ˆåŒåŸŸ <span class="mono">/forms</span> è·¯ç”±ï¼‰ã€‚</p>

    <div class="row">
      <button class="btn" id="btnFormsRefresh">åˆ·æ–°è¡¨å•å¾…å¤„ç†</button>
      <span class="pill">æ•°é‡ï¼š<span id="formsCount">0</span></span>
    </div>

    <div id="formsList" class="list"></div>
    <div class="hint" style="margin-top:12px;">è°ƒè¯•è¾“å‡ºï¼š</div>
    <pre id="formsDebug">{}</pre>
  </div>

  <!-- è¯„è®ºå®¡æ ¸ -->
  <div id="tab-comments" class="card" style="display:none;">
    <h2 style="margin:0 0 8px;">è¯„è®ºå®¡æ ¸ï¼ˆåŸåŠŸèƒ½ä¿ç•™ï¼‰</h2>
    <p class="hint" style="margin-top:0;">ç»§ç»­è°ƒç”¨ä½ çš„ <span class="mono">blast-comments-api</span>ï¼ˆåŒåŸŸ <span class="mono">/comments</span> è·¯ç”±ï¼‰ã€‚</p>

    <div class="row">
      <button class="btn" id="btnCommentsRefresh">åˆ·æ–°è¯„è®ºå¾…å®¡æ ¸</button>
      <span class="pill">å¾…å®¡æ ¸ï¼š<span id="commentsCount">0</span></span>
    </div>

    <div id="commentsList" class="list"></div>
    <div class="hint" style="margin-top:12px;">è°ƒè¯•è¾“å‡ºï¼š</div>
    <pre id="commentsDebug">{}</pre>
  </div>
</div>

<script>
  // åŒåŸŸ baseï¼ˆé¿å… workers.dev CORS / Failed to fetchï¼‰
  const MEDIA_BASE = "/media";
  const FORMS_BASE = "/forms";
  const COMMENTS_BASE = "/comments";

  const $ = (id) => document.getElementById(id);

  // token æœ¬æœºä¿å­˜
  const saved = localStorage.getItem("ADMIN_TOKEN") || "";
  $("token").value = saved;
  $("btnSave").onclick = () => {
    localStorage.setItem("ADMIN_TOKEN", $("token").value.trim());
    alert("å·²ä¿å­˜åˆ°æœ¬æœºæµè§ˆå™¨");
  };

  // tabs
  document.querySelectorAll(".tabbtn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tabbtn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      $("tab-photo").style.display = tab === "photo" ? "" : "none";
      $("tab-forms").style.display = tab === "forms" ? "" : "none";
      $("tab-comments").style.display = tab === "comments" ? "" : "none";
    });
  });

  function token() { return $("token").value.trim(); }
  function dbg(el, obj) { el.textContent = JSON.stringify(obj, null, 2); }

  // -------------------------
  // ç…§ç‰‡å®¡æ ¸ï¼ˆblast-media-apiï¼‰
  // -------------------------
  $("btnPhotoRefresh").onclick = refreshPhotos;

  async function refreshPhotos() {
    const t = token();
    const url = `${MEDIA_BASE}/admin/list?token=${encodeURIComponent(t)}&limit=50`;
    try {
      const r = await fetch(url);
      const j = await r.json();
      dbg($("photoDebug"), j);
      if (!j.ok) throw new Error(j.error || "list failed");

      $("photoCount").textContent = j.count || 0;
      renderPhotos(j.items || [], t);
    } catch (e) {
      dbg($("photoDebug"), { ok:false, error: String(e) });
    }
  }

  function renderPhotos(items, t) {
    const box = $("photoList");
    box.innerHTML = "";
    if (!items.length) {
      const div = document.createElement("div");
      div.className = "muted";
      div.textContent = "å½“å‰æ²¡æœ‰å¾…å®¡æ ¸ç…§ç‰‡ã€‚";
      box.appendChild(div);
      return;
    }

    items.forEach(it => {
      const div = document.createElement("div");
      div.className = "item";

      const head = document.createElement("div");
      head.className = "itemhead";

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="mono"><b>${it.receipt}</b> <span class="pill">${it.status}</span></div>
        <div class="muted">ç•™è¨€ï¼š${escapeHtml(it.note || "") || "(ç©º)"} ï½œ ${it.mime} ï½œ ${it.size} bytes ï½œ ${it.createdAt || ""}</div>
      `;

      const right = document.createElement("div");
      right.className = "row";

      const btnOk = document.createElement("button");
      btnOk.className = "btn";
      btnOk.textContent = "é€šè¿‡";
      btnOk.onclick = () => approvePhoto(it.receipt, t);

      const btnNo = document.createElement("button");
      btnNo.className = "btn danger";
      btnNo.textContent = "æ‹’ç»";
      btnNo.onclick = () => rejectPhoto(it.receipt, t);

      right.appendChild(btnOk);
      right.appendChild(btnNo);

      head.appendChild(left);
      head.appendChild(right);

      const body = document.createElement("div");
      body.style.marginTop = "10px";
      body.className = "grid2";

      const img = document.createElement("img");
      img.src = it.preview; // å·²å« token çš„é¢„è§ˆ URL
      img.alt = "preview";

      const info = document.createElement("div");
      info.innerHTML = `
        <div class="muted">é¢„è§ˆï¼š<span class="mono">${escapeHtml(it.preview)}</span></div>
        <div class="muted" style="margin-top:6px;">é€šè¿‡åä¼šç”Ÿæˆï¼š<span class="mono">HADO(xxx).jpg</span> å¹¶å‘å¸ƒåˆ° <span class="mono">/media/public/</span></div>
      `;

      body.appendChild(img);
      body.appendChild(info);

      div.appendChild(head);
      div.appendChild(body);
      box.appendChild(div);
    });
  }

  async function approvePhoto(receipt, t) {
    if (!confirm(`ç¡®è®¤é€šè¿‡ï¼š${receipt} ï¼Ÿ`)) return;
    try {
      const r = await fetch(`${MEDIA_BASE}/admin/approve`, {
        method: "POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify({ receipt, token: t })
      });
      const j = await r.json();
      dbg($("photoDebug"), j);
      if (!j.ok) throw new Error(j.error || "approve failed");
      alert(`å·²é€šè¿‡ï¼š${j.photo_name}\nè®¿é—®ï¼š${j.public_url}`);
      await refreshPhotos();
    } catch (e) {
      dbg($("photoDebug"), { ok:false, error:String(e) });
    }
  }

  async function rejectPhoto(receipt, t) {
    if (!confirm(`ç¡®è®¤æ‹’ç»å¹¶åˆ é™¤ï¼š${receipt} ï¼Ÿ\nï¼ˆä¼šä» pendingã€KVã€é˜Ÿåˆ—ä¸­å½»åº•ç§»é™¤ï¼‰`)) return;
    try {
      const r = await fetch(`${MEDIA_BASE}/admin/reject`, {
        method: "POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify({ receipt, token: t })
      });
      const j = await r.json();
      dbg($("photoDebug"), j);
      if (!j.ok) throw new Error(j.error || "reject failed");
      alert(`å·²æ‹’ç»å¹¶åˆ é™¤ï¼š${receipt}`);
      await refreshPhotos();
    } catch (e) {
      dbg($("photoDebug"), { ok:false, error:String(e) });
    }
  }

  // -------------------------
  // æŠ¥åå®¡æ ¸ï¼ˆåŸé€»è¾‘ï¼š/formsï¼‰
  // ä½ åŸ worker çš„ API è·¯ç”±å¦‚æœä¸åŒï¼ŒæŠŠè¿™ä¸‰å¤„ endpoint æ”¹æˆä½ çœŸå®çš„å³å¯
  // -------------------------
  $("btnFormsRefresh").onclick = refreshForms;

  async function refreshForms() {
  const t = token();
  try {
    // âœ… æ­£ç¡®æ¥å£ï¼šWorker å®ç°çš„æ˜¯ /admin/forms ï¼ˆæŒ‚åœ¨ /forms è·¯ç”±ä¸‹å°±æ˜¯ /forms/admin/formsï¼‰
    const url = `${FORMS_BASE}/admin/forms?status=new&limit=50`;

    const j = await fetchJson(url, {
      headers: { "X-Admin-Token": t }
    });

    dbg($("formsDebug"), j);
    if (!j.ok) throw new Error(j.error || "forms list failed");

    $("formsCount").textContent = j.count || (j.items ? j.items.length : 0);

    // âœ… ç”¨å¢å¼ºæ¸²æŸ“ï¼ˆå¸¦ new/done æŒ‰é’®ï¼‰
    renderFormsList($("formsList"), j.items || []);
  } catch (e) {
    dbg($("formsDebug"), { ok: false, error: String(e) });
  }
}


  // -------------------------
  // è¯„è®ºå®¡æ ¸ï¼ˆåŸé€»è¾‘ï¼š/commentsï¼‰
  // -------------------------
  $("btnCommentsRefresh").onclick = refreshComments;

  async function refreshComments() {
    const t = token();
    try {
      const r = await fetch(`${COMMENTS_BASE}/admin/list`, { headers: { "X-Admin-Token": t } });
      const j = await r.json();
      dbg($("commentsDebug"), j);
      if (!j.ok) throw new Error(j.error || "comments list failed");
      $("commentsCount").textContent = j.count || (j.items ? j.items.length : 0);
      renderJsonList($("commentsList"), j.items || []);
    } catch (e) {
      dbg($("commentsDebug"), { ok:false, error:String(e) });
    }
  }

  function renderJsonList(container, items) {
    container.innerHTML = "";
    if (!items.length) {
      const d = document.createElement("div");
      d.className = "muted";
      d.textContent = "æš‚æ— å†…å®¹ã€‚";
      container.appendChild(d);
      return;
    }
    items.forEach(it => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<pre>${escapeHtml(JSON.stringify(it, null, 2))}</pre>`;
      container.appendChild(div);
    });
  }

  async function fetchJson(url, options = {}) {
  const r = await fetch(url, options);

  // å…ˆè¯»æˆ textï¼Œå†åˆ¤æ–­æ˜¯ä¸æ˜¯ JSONï¼Œé¿å…ä½ è¿™æ¬¡è¿™ç§ â€œNot foundâ€ è§£æç‚¸è£‚
  const ct = (r.headers.get("content-type") || "").toLowerCase();
  const text = await r.text();

  if (!ct.includes("application/json")) {
    throw new Error(`HTTP ${r.status} éJSONå“åº”ï¼š${text.slice(0, 160)}`);
  }
  const j = JSON.parse(text);
  return j;
}

function renderFormsList(container, items) {
  container.innerHTML = "";
  if (!items.length) {
    container.innerHTML = `<div class="muted">æš‚æ— æ–°æŠ¥å</div>`;
    return;
  }

  items.forEach((it) => {
    const div = document.createElement("div");
    div.className = "item";

    const id = it.id || "";
    const status = it.status || "unknown";
    const title = `${it.childName || "æœªå‘½å"}ï¼ˆ${it.age || "?"}ï¼‰`;
    const contact = it.contact || "";
    const createdAt = it.createdAt || "";

    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:8px;">
        <div>
          <div style="font-weight:700">${escapeHtml(title)}</div>
          <div class="muted" style="font-size:12px;word-break:break-all">
            id: ${escapeHtml(id)} ï½œ status: <b>${escapeHtml(status)}</b> ï½œ ${escapeHtml(createdAt)}
          </div>
          <div class="muted" style="font-size:12px">è”ç³»æ–¹å¼ï¼š${escapeHtml(contact)}</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn" data-act="done">æ ‡è®° done</button>
          <button class="btn" data-act="new">è¿˜åŸ new</button>
        </div>
      </div>
      <pre>${escapeHtml(JSON.stringify(it, null, 2))}</pre>
    `;

    div.querySelectorAll("button[data-act]").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const next = btn.getAttribute("data-act");
        await updateFormStatus(id, next);
        // æ›´æ–°å®Œååˆ·æ–°åˆ—è¡¨
        await refreshForms();
      });
    });

    container.appendChild(div);
  });
}

async function updateFormStatus(id, status) {
  const t = token();
  const j = await fetchJson(`${FORMS_BASE}/admin/forms/update`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Admin-Token": t
    },
    body: JSON.stringify({ id, status })
  });
  if (!j.ok) throw new Error(j.error || "update failed");
  return j;
}


  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // é¡µé¢åŠ è½½æ—¶é»˜è®¤åˆ·æ–°ç…§ç‰‡é˜Ÿåˆ—
  refreshPhotos();
</script>
</body>
</html>
