<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Media Admin</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:20px;background:#f6f7fb}
    header{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input,button{padding:10px 12px;border:1px solid #d0d5dd;border-radius:10px}
    button{cursor:pointer;background:#111827;color:#fff;border:none}
    button.secondary{background:#fff;color:#111827;border:1px solid #d0d5dd}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;margin-top:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .card .top{display:flex;justify-content:space-between;gap:10px;padding:12px 12px 8px}
    .meta{font-size:12px;color:#6b7280;line-height:1.4}
    .note{font-size:13px;color:#111827;margin-top:6px}
    .actions{display:flex;gap:10px;padding:12px}
    .actions button{flex:1}
    .imgwrap{background:#111827;display:flex;align-items:center;justify-content:center;aspect-ratio:16/10}
    .imgwrap img{max-width:100%;max-height:100%;object-fit:contain}
    .status{margin-left:auto;font-size:12px;color:#6b7280}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .err{color:#b91c1c;font-size:13px;margin-top:10px}
  </style>
</head>
<body>
  <header>
    <h2 style="margin:0">媒体审核后台</h2>
    <input id="token" placeholder="粘贴 ADMIN_TOKEN（Bearer token 的值）" style="min-width:340px" />
    <button id="refresh">刷新列表</button>
    <span class="status" id="status"></span>
  </header>

  <div id="err" class="err"></div>
  <div id="grid" class="grid"></div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setStatus(t){ $("status").textContent = t || ""; }
    function setErr(t){ $("err").textContent = t || ""; }

    function authHeaders(){
      const t = ($("token").value || "").trim();
      return { "Authorization": "Bearer " + t };
    }

    async function api(path, opts={}){
      const headers = Object.assign({}, authHeaders(), opts.headers || {});
      const res = await fetch(path, Object.assign({}, opts, { headers }));
      const ct = res.headers.get("content-type") || "";
      const data = ct.includes("application/json") ? await res.json() : await res.text();
      if(!res.ok) throw new Error(typeof data === "string" ? data : (data.detail || data.error || "request failed"));
      return data;
    }

    function card(it){
      const div = document.createElement("div");
      div.className = "card";

      const img = document.createElement("img");
      img.alt = it.upload_id;
      img.src = `/media/admin/preview/${encodeURIComponent(it.upload_id)}`;
      img.loading = "lazy";

      const imgwrap = document.createElement("div");
      imgwrap.className = "imgwrap";
      imgwrap.appendChild(img);

      const top = document.createElement("div");
      top.className = "top";
      top.innerHTML = `
        <div>
          <div class="meta"><span class="pill">pending</span> ${it.upload_id}</div>
          <div class="meta">文件：${it.filename || "-"}</div>
          <div class="meta">时间：${it.created_at || "-"}</div>
          <div class="note">备注：${(it.note || "").replace(/</g,"&lt;")}</div>
        </div>
      `;

      const actions = document.createElement("div");
      actions.className = "actions";

      const approve = document.createElement("button");
      approve.textContent = "Approve";
      approve.onclick = async () => {
        approve.disabled = true; deny.disabled = true;
        try{
          setStatus("Approving...");
          const r = await api(`/media/admin/approve/${encodeURIComponent(it.upload_id)}`, { method:"POST" });
          setStatus(`Approved -> photo_id=${r.photo_id}`);
          await load();
        }catch(e){
          setErr(String(e.message||e));
          setStatus("");
        }finally{
          approve.disabled = false; deny.disabled = false;
        }
      };

      const deny = document.createElement("button");
      deny.textContent = "Deny";
      deny.className = "secondary";
      deny.onclick = async () => {
        deny.disabled = true; approve.disabled = true;
        try{
          setStatus("Denying...");
          await api(`/media/admin/deny/${encodeURIComponent(it.upload_id)}`, { method:"POST" });
          setStatus("Denied");
          await load();
        }catch(e){
          setErr(String(e.message||e));
          setStatus("");
        }finally{
          deny.disabled = false; approve.disabled = false;
        }
      };

      actions.appendChild(approve);
      actions.appendChild(deny);

      div.appendChild(imgwrap);
      div.appendChild(top);
      div.appendChild(actions);
      return div;
    }

    async function load(){
      setErr("");
      setStatus("Loading...");
      const grid = $("grid");
      grid.innerHTML = "";

      const data = await api("/media/admin/list");
      const items = data.items || [];
      if(items.length === 0){
        setStatus("没有待审核图片");
        return;
      }
      setStatus(`待审核：${items.length} 张`);
      for(const it of items){
        grid.appendChild(card(it));
      }
    }

    $("refresh").onclick = () => load().catch(e => setErr(String(e.message||e)));

    // auto load if token saved
    try{
      const saved = localStorage.getItem("ADMIN_TOKEN_VALUE");
      if(saved) $("token").value = saved;
    }catch{}
    $("token").addEventListener("change", () => {
      try{ localStorage.setItem("ADMIN_TOKEN_VALUE", ($("token").value||"").trim()); }catch{}
    });

    load().catch(e => setErr(String(e.message||e)));
  </script>
</body>
</html>
