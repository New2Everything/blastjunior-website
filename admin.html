<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åª’ä½“å®¡æ ¸åå° - å…°æ˜Ÿå°‘å¹´ä¿±ä¹éƒ¨</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;margin:22px;max-width:980px}
    h1{margin:6px 0 10px}
    .muted{color:#666;font-size:13px;line-height:1.5}
    .tabs{display:flex;gap:10px;margin:14px 0}
    .tab{padding:10px 14px;border:1px solid #ddd;border-radius:12px;background:#fff;cursor:pointer}
    .tab.active{border-color:#2b6cb0;box-shadow:0 0 0 2px rgba(43,108,176,.12)}
    .card{border:1px solid #eee;border-radius:14px;padding:16px;margin:12px 0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="password"],input[type="text"],input[type="number"]{padding:10px 12px;border:1px solid #ddd;border-radius:10px;min-width:260px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #2b6cb0;background:#fff;cursor:pointer}
    button.primary{background:#2b6cb0;color:#fff}
    button.danger{border-color:#b91c1c;color:#b91c1c}
    pre{background:#0b1020;color:#e7e7e7;padding:12px;border-radius:12px;overflow:auto}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .item{border:1px solid #eee;border-radius:12px;padding:12px}
    img.preview{max-width:100%;border-radius:12px;border:1px solid #eee;background:#fafafa}
    .pill{display:inline-block;padding:3px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#444}
    .spacer{height:8px}
  </style>
</head>
<body>
  <h1>åª’ä½“å®¡æ ¸åå°</h1>
  <div class="muted">
    - è¿™é‡ŒæŠŠâ€œåŸæ¥çš„æŠ¥å/ç•™è¨€å®¡æ ¸ã€è¯„è®ºå®¡æ ¸â€ä¿ç•™ï¼ŒåŒæ—¶æ–°å¢â€œç…§ç‰‡ä¸Šä¼ å®¡æ ¸â€ã€‚<br/>
    - ç…§ç‰‡å®¡æ ¸èµ°æœ¬ç«™æ¥å£ï¼š<code>/media/admin/*</code>ï¼›æŠ¥å/è¯„è®ºä»èµ°ä½ åŸæ¥çš„ workers.dev æœåŠ¡ã€‚<br/>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="photos">ğŸ“· ç…§ç‰‡å®¡æ ¸</div>
    <div class="tab" data-tab="forms">ğŸ“ æŠ¥å/ç”³è¯·å®¡æ ¸</div>
    <div class="tab" data-tab="comments">ğŸ’¬ è¯„è®ºå®¡æ ¸</div>
  </div>

  <!-- =============== ç…§ç‰‡å®¡æ ¸ =============== -->
  <section id="tab-photos" class="card">
    <h2 style="margin:0 0 8px">ç…§ç‰‡å®¡æ ¸ï¼ˆæ¥è‡ª /media/uploadï¼‰</h2>
    <div class="muted">éœ€è¦ç®¡ç†å‘˜å£ä»¤ï¼ˆADMIN_TOKENï¼‰ã€‚å¾…å®¡æ ¸å›¾ç‰‡åœ¨ R2 çš„ <code>pending/</code>ï¼Œé€šè¿‡åè¿›å…¥ <code>public/</code> å¹¶å¯ç”¨ <code>/media/public/&lt;æ”¶æ®ç &gt;</code> è®¿é—®ã€‚</div>

    <div class="spacer"></div>

    <div class="row">
      <label>ç®¡ç†å‘˜å£ä»¤ï¼š</label>
      <input id="adminToken" type="password" placeholder="ADMIN_TOKENï¼ˆä»…ç”¨äºå®¡æ ¸ï¼‰" />
      <button class="primary" id="btnLoadPending">åˆ·æ–°å¾…å®¡æ ¸</button>
      <span class="pill" id="pendingCount">å¾…å®¡æ ¸ï¼š0</span>
    </div>

    <div class="spacer"></div>

    <div id="pendingList" class="grid"></div>

    <div class="spacer"></div>
    <div class="muted">è°ƒè¯•è¾“å‡ºï¼š</div>
    <pre id="photoDebug">{}</pre>
  </section>

  <!-- =============== åŸæŠ¥å/ç”³è¯·å®¡æ ¸ï¼ˆä¿ç•™ï¼‰ =============== -->
  <section id="tab-forms" class="card" style="display:none">
    <h2 style="margin:0 0 8px">æŠ¥å/ç”³è¯·å®¡æ ¸ï¼ˆåŸåŠŸèƒ½ä¿ç•™ï¼‰</h2>
    <div class="muted">è¿™å—ç»§ç»­è°ƒç”¨ä½ çš„ contact-form-handlerï¼ˆworkers.devï¼‰ã€‚</div>

    <div class="spacer"></div>
    <div class="row">
      <button class="primary" id="btnLoadForms">åˆ·æ–°è¡¨å•å¾…å¤„ç†</button>
      <span class="pill" id="formsCount">0</span>
    </div>

    <div class="spacer"></div>
    <div id="formsList" class="grid"></div>

    <div class="spacer"></div>
    <div class="muted">è°ƒè¯•è¾“å‡ºï¼š</div>
    <pre id="formsDebug">{}</pre>
  </section>

  <!-- =============== åŸè¯„è®ºå®¡æ ¸ï¼ˆä¿ç•™ï¼‰ =============== -->
  <section id="tab-comments" class="card" style="display:none">
    <h2 style="margin:0 0 8px">è¯„è®ºå®¡æ ¸ï¼ˆåŸåŠŸèƒ½ä¿ç•™ï¼‰</h2>
    <div class="muted">è¿™å—ç»§ç»­è°ƒç”¨ä½ çš„ blast-comments-apiï¼ˆworkers.devï¼‰ã€‚</div>

    <div class="spacer"></div>
    <div class="row">
      <button class="primary" id="btnLoadComments">åˆ·æ–°è¯„è®ºå¾…å®¡æ ¸</button>
      <span class="pill" id="commentsCount">0</span>
    </div>

    <div class="spacer"></div>
    <div id="commentsList" class="grid"></div>

    <div class="spacer"></div>
    <div class="muted">è°ƒè¯•è¾“å‡ºï¼š</div>
    <pre id="commentsDebug">{}</pre>
  </section>

<script>
/** ========= ä½ åŸæ¥çš„ä¸¤ä¸ªåç«¯ï¼ˆæŒ‰åŸadmin.htmlä¹ æƒ¯ä¿ç•™ï¼‰ ========= */
const FORMS_API_BASE    = "https://contact-form-handler.kanjiaming2022.workers.dev";
const COMMENTS_API_BASE = "https://blast-comments-api.kanjiaming2022.workers.dev";

/** ========= ç…§ç‰‡å®¡æ ¸åç«¯ï¼ˆèµ°æœ¬ç«™ /media/*ï¼‰ ========= */
const MEDIA_ADMIN_PENDING = "/media/admin/pending";
const MEDIA_ADMIN_FILE    = (receipt, token) => `/media/admin/file/${encodeURIComponent(receipt)}?token=${encodeURIComponent(token)}`;
const MEDIA_ADMIN_APPROVE = "/media/admin/approve";
const MEDIA_ADMIN_REJECT  = "/media/admin/reject";

const $ = (id) => document.getElementById(id);

/** Tabs */
document.querySelectorAll(".tab").forEach(t => {
  t.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    t.classList.add("active");
    const k = t.dataset.tab;
    $("tab-photos").style.display   = k === "photos" ? "" : "none";
    $("tab-forms").style.display    = k === "forms" ? "" : "none";
    $("tab-comments").style.display = k === "comments" ? "" : "none";
  });
});

/** ====== ç…§ç‰‡å®¡æ ¸ ====== */
$("btnLoadPending").addEventListener("click", loadPending);

async function loadPending() {
  const token = $("adminToken").value.trim();
  if (!token) {
    alert("è¯·å…ˆè¾“å…¥ ADMIN_TOKENï¼ˆä»…ç”¨äºå®¡æ ¸ï¼‰");
    return;
  }
  $("pendingList").innerHTML = "";
  $("photoDebug").textContent = "{}";

  const url = new URL(MEDIA_ADMIN_PENDING, location.origin);
  url.searchParams.set("limit", "30");
  url.searchParams.set("token", token);

  const res = await fetch(url.toString(), { method: "GET" });
  const data = await res.json().catch(() => ({}));
  $("photoDebug").textContent = JSON.stringify(data, null, 2);

  const items = data.items || [];
  $("pendingCount").textContent = `å¾…å®¡æ ¸ï¼š${items.length}`;

  if (!items.length) {
    $("pendingList").innerHTML = `<div class="muted">å½“å‰æ²¡æœ‰å¾…å®¡æ ¸ç…§ç‰‡ã€‚</div>`;
    return;
  }

  for (const it of items) {
    const div = document.createElement("div");
    div.className = "item";

    const receipt = it.receipt || "(unknown)";
    const note = it.note || "";
    const createdAt = it.createdAt || "";
    const mime = it.mime || "";
    const size = it.size || "";

    div.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <div><b>${receipt}</b> <span class="pill">${it.status}</span></div>
          <div class="muted">ç•™è¨€ï¼š${escapeHtml(note)} ï½œ ${escapeHtml(mime)} ï½œ ${escapeHtml(String(size))} bytes ï½œ ${escapeHtml(createdAt)}</div>
        </div>
        <div class="row">
          <button class="primary" data-act="approve">é€šè¿‡</button>
          <button class="danger" data-act="reject">æ‹’ç»</button>
        </div>
      </div>
      <div class="spacer"></div>
      <img class="preview" src="${MEDIA_ADMIN_FILE(receipt, token)}" alt="preview" />
    `;

    div.querySelector('[data-act="approve"]').addEventListener("click", async () => {
      await approveOne(receipt, token);
      await loadPending();
    });

    div.querySelector('[data-act="reject"]').addEventListener("click", async () => {
      const reason = prompt("æ‹’ç»åŸå› ï¼ˆå¯é€‰ï¼Œâ‰¤80å­—ï¼‰", "") || "";
      await rejectOne(receipt, token, reason);
      await loadPending();
    });

    $("pendingList").appendChild(div);
  }
}

async function approveOne(receipt, token) {
  const res = await fetch(MEDIA_ADMIN_APPROVE + `?token=${encodeURIComponent(token)}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ receipt }),
  });
  const data = await res.json().catch(() => ({}));
  $("photoDebug").textContent = JSON.stringify(data, null, 2);
}

async function rejectOne(receipt, token, reason) {
  const res = await fetch(MEDIA_ADMIN_REJECT + `?token=${encodeURIComponent(token)}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ receipt, reason }),
  });
  const data = await res.json().catch(() => ({}));
  $("photoDebug").textContent = JSON.stringify(data, null, 2);
}

/** ====== è¡¨å•å®¡æ ¸ï¼ˆåŸåŠŸèƒ½ï¼šè¿™é‡Œåªåšâ€œæŸ¥çœ‹â€ï¼Œä¸å¼ºè¡Œæ”¹ä½ åŸæ¥å£ï¼‰ ====== */
$("btnLoadForms").addEventListener("click", loadForms);

async function loadForms() {
  $("formsList").innerHTML = "";
  $("formsDebug").textContent = "{}";
  try {
    // ä½ åŸ admin é‡Œå…·ä½“ endpoint å¯èƒ½ä¸åŒï¼Œè¿™é‡Œç”¨ä¸€ä¸ªâ€œå¯æ›¿æ¢â€çš„é»˜è®¤
    const res = await fetch(`${FORMS_API_BASE}/admin/list`);
    const data = await res.json().catch(() => ({}));
    $("formsDebug").textContent = JSON.stringify(data, null, 2);

    const items = data.items || data.data || [];
    $("formsCount").textContent = `å¾…å¤„ç†ï¼š${items.length}`;

    if (!items.length) {
      $("formsList").innerHTML = `<div class="muted">æš‚æ— å¾…å¤„ç†è¡¨å•ï¼ˆå¦‚æ¥å£ä¸åŒï¼ŒæŠŠ /admin/list æ”¹æˆä½ å®é™…è·¯å¾„ï¼‰ã€‚</div>`;
      return;
    }

    for (const it of items) {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<pre>${escapeHtml(JSON.stringify(it, null, 2))}</pre>`;
      $("formsList").appendChild(div);
    }
  } catch (e) {
    $("formsDebug").textContent = JSON.stringify({ ok:false, error:String(e) }, null, 2);
  }
}

/** ====== è¯„è®ºå®¡æ ¸ï¼ˆåŸåŠŸèƒ½ï¼šä¿ç•™æŸ¥çœ‹ + approve ç¤ºä¾‹ï¼›ä½ åŸadminé‡Œæ›´å®Œæ•´ï¼‰ ====== */
$("btnLoadComments").addEventListener("click", loadComments);

async function loadComments() {
  $("commentsList").innerHTML = "";
  $("commentsDebug").textContent = "{}";
  try {
    const params = new URLSearchParams();
    params.set("status", "pending");
    params.set("limit", "30");

    const res = await fetch(`${COMMENTS_API_BASE}/admin/comments?` + params.toString(), { method: "GET" });
    const data = await res.json().catch(() => ({}));
    $("commentsDebug").textContent = JSON.stringify(data, null, 2);

    const items = data.items || [];
    $("commentsCount").textContent = `å¾…å®¡æ ¸ï¼š${items.length}`;

    if (!items.length) {
      $("commentsList").innerHTML = `<div class="muted">æš‚æ— å¾…å®¡æ ¸è¯„è®ºã€‚</div>`;
      return;
    }

    for (const it of items) {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div>
            <div><b>${escapeHtml(it.id || "")}</b> <span class="pill">${escapeHtml(it.status || "")}</span></div>
            <div class="muted">${escapeHtml(it.text || it.content || "")}</div>
          </div>
          <div class="row">
            <button class="primary" data-act="approve">é€šè¿‡</button>
          </div>
        </div>
      `;
      div.querySelector('[data-act="approve"]').addEventListener("click", async () => {
        await approveComment(it.id);
        await loadComments();
      });
      $("commentsList").appendChild(div);
    }
  } catch (e) {
    $("commentsDebug").textContent = JSON.stringify({ ok:false, error:String(e) }, null, 2);
  }
}

async function approveComment(id) {
  const res = await fetch(`${COMMENTS_API_BASE}/admin/comments/approve`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id }),
  });
  const data = await res.json().catch(() => ({}));
  $("commentsDebug").textContent = JSON.stringify(data, null, 2);
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
</script>
</body>
</html>
