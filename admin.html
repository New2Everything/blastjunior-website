<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>兰星少年俱乐部 - 媒体审核后台</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;margin:22px;max-width:1100px}
    h1{margin:0 0 12px 0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="password"], input[type="text"]{padding:10px 12px;border:1px solid #ddd;border-radius:10px;min-width:260px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #2b6cb0;background:#fff;cursor:pointer}
    button.primary{background:#2b6cb0;color:#fff}
    button.danger{border-color:#b02b2b;color:#b02b2b}
    .muted{color:#666;font-size:12px}
    .card{border:1px solid #eee;border-radius:14px;padding:14px;margin:14px 0}
    .grid{display:grid;grid-template-columns:240px 1fr;gap:14px}
    img{width:240px;height:240px;object-fit:cover;border-radius:12px;border:1px solid #eee;background:#fafafa}
    pre{background:#0b1020;color:#e7e7e7;padding:12px;border-radius:12px;overflow:auto}
    .tag{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #eee;background:#fafafa;font-size:12px;margin-right:8px}
    .ok{color:#0a7a2f}
    .bad{color:#b02b2b}
  </style>
</head>
<body>
  <h1>媒体审核后台</h1>
  <div class="muted">说明：此页需要管理员口令（ADMIN_TOKEN）。待审核图片来自 /media/upload。</div>

  <div class="card">
    <div class="row">
      <label>管理员口令：</label>
      <input id="token" type="password" placeholder="粘贴 ADMIN_TOKEN" />
      <button class="primary" id="btnLoad">刷新待审核</button>
      <span id="stat" class="muted"></span>
    </div>
    <div class="muted" style="margin-top:8px;">
      图片预览通过：<span class="tag">/media/admin/file/&lt;receipt&gt;?token=...</span>
      审核接口：<span class="tag">POST /media/admin/approve</span>
      <span class="tag">POST /media/admin/reject</span>
    </div>
  </div>

  <div id="list"></div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="muted">调试输出：</div>
      <button id="btnClear">清空</button>
    </div>
    <pre id="log">{}</pre>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const log = (obj) => { $("log").textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2); };
  const setStat = (s) => { $("stat").textContent = s; };

  $("btnClear").onclick = () => log("{}");

  $("btnLoad").onclick = async () => {
    const token = $("token").value.trim();
    if (!token) { alert("请先输入管理员口令"); return; }

    setStat("加载中...");
    $("list").innerHTML = "";

    try {
      const res = await fetch("/media/admin/pending", {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json().catch(() => ({}));
      log(data);

      if (!res.ok) {
        setStat("加载失败");
        alert("加载失败：" + (data.error || res.status));
        return;
      }

      setStat(`待审核：${data.count} 条`);
      renderList(data.items || [], token);
    } catch (e) {
      setStat("加载失败");
      log(String(e));
      alert("加载失败：" + e);
    }
  };

  function renderList(items, token) {
    const root = $("list");
    if (!items.length) {
      root.innerHTML = `<div class="muted">当前没有待审核内容。</div>`;
      return;
    }

    root.innerHTML = items.map(it => {
      const imgUrl = `${it.preview_url}?token=${encodeURIComponent(token)}`;
      return `
        <div class="card" data-receipt="${escapeHtml(it.receipt)}">
          <div class="grid">
            <div>
              <img src="${imgUrl}" alt="preview" />
            </div>
            <div>
              <div style="margin-bottom:8px;">
                <span class="tag">receipt: ${escapeHtml(it.receipt)}</span>
                <span class="tag">${escapeHtml(it.mime || "")}</span>
                <span class="tag">${escapeHtml(String(it.size || ""))} bytes</span>
              </div>
              <div class="muted">上传时间：${escapeHtml(it.createdAt || "")}</div>
              <div style="margin:10px 0;">
                <div class="muted">留言：</div>
                <div>${escapeHtml(it.note || "")}</div>
              </div>

              <div class="row" style="margin-top:12px;">
                <button class="primary" onclick="approve('${encodeURIComponent(it.receipt)}')">通过</button>
                <button class="danger" onclick="rejectOne('${encodeURIComponent(it.receipt)}')">拒绝</button>
                <button onclick="copyText('${escapeHtml(it.receipt)}')">复制收据码</button>
                <button onclick="openLookup('${encodeURIComponent(it.receipt)}')">打开公开查询</button>
              </div>

              <div class="muted" style="margin-top:8px;">
                公开查询：<span class="tag">/media/receipt/${escapeHtml(it.receipt)}</span>
              </div>

              <div id="msg-${escapeHtml(it.receipt)}" class="muted" style="margin-top:10px;"></div>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  window.copyText = async (t) => {
    try { await navigator.clipboard.writeText(t); alert("已复制：" + t); }
    catch { prompt("复制失败，请手动复制：", t); }
  };

  window.openLookup = (receiptEnc) => {
    const receipt = decodeURIComponent(receiptEnc);
    window.open(`/media/receipt/${encodeURIComponent(receipt)}`, "_blank");
  };

  window.approve = async (receiptEnc) => {
    const token = $("token").value.trim();
    const receipt = decodeURIComponent(receiptEnc);
    const msgEl = $("msg-" + receipt);
    msgEl.textContent = "提交通过中...";

    try {
      const res = await fetch("/media/admin/approve", {
        method: "POST",
        headers: { "Content-Type":"application/json", "Authorization":"Bearer " + token },
        body: JSON.stringify({ receipt })
      });
      const data = await res.json().catch(() => ({}));
      log(data);

      if (!res.ok) {
        msgEl.innerHTML = `<span class="bad">通过失败：</span>${escapeHtml(data.error || res.status)}`;
        return;
      }

      msgEl.innerHTML = `<span class="ok">已通过</span>，公开链接： <a href="${escapeHtml(data.public_url)}" target="_blank">${escapeHtml(data.public_url)}</a>`;
      // 从列表移除
      const card = document.querySelector(`[data-receipt="${cssEscape(receipt)}"]`);
      if (card) card.remove();
    } catch (e) {
      msgEl.innerHTML = `<span class="bad">通过失败：</span>${escapeHtml(String(e))}`;
    }
  };

  window.rejectOne = async (receiptEnc) => {
    const token = $("token").value.trim();
    const receipt = decodeURIComponent(receiptEnc);
    const reason = prompt("拒绝原因（可留空，<=30字）", "") || "";
    const msgEl = $("msg-" + receipt);
    msgEl.textContent = "提交拒绝中...";

    try {
      const res = await fetch("/media/admin/reject", {
        method: "POST",
        headers: { "Content-Type":"application/json", "Authorization":"Bearer " + token },
        body: JSON.stringify({ receipt, reason })
      });
      const data = await res.json().catch(() => ({}));
      log(data);

      if (!res.ok) {
        msgEl.innerHTML = `<span class="bad">拒绝失败：</span>${escapeHtml(data.error || res.status)}`;
        return;
      }

      msgEl.innerHTML = `<span class="ok">已拒绝</span>`;
      const card = document.querySelector(`[data-receipt="${cssEscape(receipt)}"]`);
      if (card) card.remove();
    } catch (e) {
      msgEl.innerHTML = `<span class="bad">拒绝失败：</span>${escapeHtml(String(e))}`;
    }
  };

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function cssEscape(s){
    // basic escape for attribute selector
    return String(s).replace(/"/g, '\\"');
  }
</script>
</body>
</html>
