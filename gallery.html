<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…°æ˜Ÿå°‘å¹´ä¿±ä¹éƒ¨ Â· ç…§ç‰‡å®‡å®™</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
<header>
  <div class="container nav">
    <div class="nav-left">
      <div class="nav-logo">L</div>
      <div>å…°æ˜Ÿå°‘å¹´ä¿±ä¹éƒ¨ Â· ç…§ç‰‡å®‡å®™</div>
    </div>
    <a href="index.html">è¿”å›é¦–é¡µ</a>
  </div>
</header>

<main>
  <div class="container">
    <div class="intro-card">
      <h1>å…°æ˜Ÿå°‘å¹´ Â· ç…§ç‰‡å®‡å®™ï¼ˆUnder Construction)</h1>
      <p class="subtitle-small">
        å¦‚æœæŸå¼ ç…§ç‰‡è®©ä½ æƒ³èµ·æœ‰è¶£çš„æ•…äº‹ã€æ¯”èµ›çš„é‚£ä¸€ç§’ã€æŸä¸ªå­©å­çš„é—ªå…‰ç‚¹ï¼Œ
        æ¬¢è¿åœ¨ç…§ç‰‡ä¸‹æ–¹ç•™è¨€ï¼Œä¸€èµ·æŠŠè¿™ç‰‡ç…§ç‰‡å®‡å®™â€œè£…ä¿®â€å¾—æ›´çƒ­é—¹ã€æ›´æœ‰æ¸©åº¦ã€‚
      </p>

      <div class="notice">
        <p style="margin-bottom: 4px;"><strong>ğŸ“Œ æ¸©é¦¨æç¤ºï¼ˆä¸­æ–‡ï¼‰</strong><br>
          å¦‚æœä½ å‘ç°æŸå¼ ç…§ç‰‡ä¸é€‚åˆå…¬å¼€å±•ç¤ºï¼Œè¯·åœ¨è¯¥ç…§ç‰‡ç•™è¨€å¤„ç•™è¨€æˆ–é‚®ä»¶è”ç³»æˆ‘ä»¬ï¼š
          <a href="mailto:blastjunior@163.com">blastjunior@163.com</a>ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†å¹¶ä¸‹æ¶ã€‚
        </p>

        <p style="margin-bottom: 4px;"><strong>ğŸ“Œ Friendly Notice (English)</strong><br>
          If you find a photo that you believe should not be displayed,
          please leave a message under that photo or contact us at
          <a href="mailto:blastjunior@163.com">blastjunior@163.com</a>.
          We will review and remove it as soon as possible.
        </p>

        <p style="margin-bottom: 4px;"><strong>ğŸ“Œ ã”é€£çµ¡ãã ã•ã„ï¼ˆæ—¥æœ¬èªï¼‰</strong><br>
          å…¬é–‹ã«ä¸é©åˆ‡ã¨æ€ã‚ã‚Œã‚‹å†™çœŸãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ãã®å†™çœŸã®ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ®‹ã™ã‹ã€
          <a href="mailto:blastjunior@163.com">blastjunior@163.com</a> ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚
          ç¢ºèªå¾Œã€é€Ÿã‚„ã‹ã«å‰Šé™¤ã„ãŸã—ã¾ã™ã€‚
        </p>

        <p style="margin-bottom: 0;"><strong>ğŸ“Œ ì•ˆë‚´ë¬¸ (í•œêµ­ì–´)</strong><br>
          ê³µê°œë˜ê¸° ì–´ë ¤ìš´ ì‚¬ì§„ì„ ë°œê²¬í•˜ì‹œë©´, í•´ë‹¹ ì‚¬ì§„ì˜ ëŒ“ê¸€ì— ë‚¨ê²¨ì£¼ì‹œê±°ë‚˜
          <a href="mailto:blastjunior@163.com">blastjunior@163.com</a> ìœ¼ë¡œ ì—°ë½ì£¼ì„¸ìš”.
          í™•ì¸ í›„ ì‹ ì†íˆ ì‚­ì œí•˜ê² ìŠµë‹ˆë‹¤.
        </p>
      </div>
    </div>

    <div class="universe-bg">
      <div class="stars"></div>
      <div class="shooting-star"></div>

      <div class="floating-wrapper">
        <div class="floating-wall" id="floatingWall">
          <!-- JS ä¼šåœ¨è¿™é‡Œç”Ÿæˆéšæœºæ•£è½ / å †å çš„ç…§ç‰‡ -->
        </div>
      </div>
    </div>
  </div>
</main>

<div class="footer-nav">
  <a href="index.html">é¦–é¡µ</a>
  <a href="honor.html">è£èª‰å®¤</a>
  <a href="gallery.html">ç…§ç‰‡å¢™</a>
  <a href="news.html">æ–°é—»ä¸­å¿ƒ</a>
</div>

<footer>
  Â© <script>document.write(new Date().getFullYear())</script> å…°æ˜Ÿå°‘å¹´ä¿±ä¹éƒ¨ Â· Photo Wall
</footer>

<!-- ç…§ç‰‡å®‡å®™è„šæœ¬ï¼ˆç¼©ç•¥å›¾ + å»¶è¿ŸåŠ è½½åŸå›¾ï¼‰ -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const wall = document.getElementById("floatingWall");
  if (!wall) return;

  const IMAGE_BASE = "/media/web";
  const THUMB_BASE = "/media/thumb";
  const MIN_SINGLES = 30;

  // ---- ç•™è¨€ API åŸºç¡€åœ°å€ ----
  const COMMENTS_API_BASE = ""; // åŒåŸŸï¼šèµ° www.blastjunior.com/comments/*


  let currentPhotoId = null;
  let commentsCursor = null;
  let isCommentsLoading = false;

    function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  /* ---------- æŠ˜å å±å‹å¥½çš„å¯è§†é«˜åº¦ ---------- */
  function getViewportHeight() {
    if (window.visualViewport && window.visualViewport.height) {
      return window.visualViewport.height;
    }
    return window.innerHeight || document.documentElement.clientHeight || 800;
  }

  /* ---------- æ¨¡æ€æ¡†æ‰“å¼€ / å…³é—­ ---------- */
    /* ---------- æ¨¡æ€æ¡†æ‰“å¼€ / å…³é—­ ---------- */
  function openModal(photo) {
    const modal = document.getElementById("photoModal");
    const img   = document.getElementById("modalImage");
    const idSpan = document.getElementById("modalPhotoId");

    if (!modal || !img || !idSpan) return;

    // å›ºå®šç¼–å·ï¼šç›´æ¥ç”¨ photo.idï¼ˆæ¥è‡ªæ–‡ä»¶åï¼‰
    idSpan.textContent = `#${String(photo.id).padStart(3, "0")}`;

    // æ¸…ç©ºæ—§å›¾ï¼Œé¿å…é—ªçƒ
    img.onerror = null;
    img.onload = null;
    img.src = "";

    modal.classList.add("visible");

    const vh = getViewportHeight();
    const modalInner = modal.querySelector(".modal-inner");
    if (modalInner) modalInner.style.maxHeight = Math.round(vh * 0.9) + "px";
    img.style.maxHeight = Math.round(vh * 0.55) + "px";

    // === å…³é”®ï¼šå¤šè·¯å¾„å…œåº• ===
    // ä½ ç°åœ¨ photo.full æ˜¯ /media/web/<safe>ï¼Œphoto.thumb æ˜¯ /media/thumb/<safe>ï¼ˆè§ä½ å½“å‰ mappingï¼‰:contentReference[oaicite:3]{index=3}
    // è¿™é‡Œæˆ‘ä»¬å†åŠ å‡ ä¸ªå€™é€‰è·¯å¾„ï¼Œé¿å… web ç‰ˆæœ¬ç¼ºå¤±å¯¼è‡´é»‘å±
    const safeName = encodeFile(photo.name || photo.file || photo.original || "");
    const candidates = [
      photo.full,                               // /media/web/<safe>
      `/media/original/${safeName}`,            // å¯èƒ½å­˜åœ¨
      `/media/raw/${safeName}`,                 // å¯èƒ½å­˜åœ¨
      `/media/full/${safeName}`,                // å¯èƒ½å­˜åœ¨
      `/media/${safeName}`,                     // å…œåº•
      photo.thumb                               // æœ€åé€€å›ç¼©ç•¥å›¾ï¼Œè‡³å°‘ä¸é»‘å±
    ].filter(Boolean);

    let idx = 0;
    const tryNext = () => {
      if (idx >= candidates.length) return;
      const url = candidates[idx++];
      img.src = url;
    };

    img.onerror = () => {
      // ä½ å¯ä»¥æ‰“å¼€æµè§ˆå™¨ Console çœ‹çœ‹åˆ°åº•å“ªæ¡ 404
      console.warn("Modal image failed, try fallback:", img.src);
      tryNext();
    };

    // å…ˆåŠ è½½ç¬¬ä¸€æ¡
    tryNext();

    // ---- æ‰“å¼€æ—¶é‡ç½®å¹¶åŠ è½½è¯¥ç…§ç‰‡çš„ç•™è¨€ ----
    resetComments(photo.id);
    loadComments(photo.id);
  }


    function closeModal() {
    const modal = document.getElementById("photoModal");
    const img   = document.getElementById("modalImage");
    const textarea = document.getElementById("commentText");
    const listEl = document.getElementById("commentList");
    const placeholder = document.getElementById("modalPlaceholderText");
    const loadMoreBtn = document.getElementById("commentLoadMoreBtn");

    if (modal) modal.classList.remove("visible");
    if (img) img.src = "";
    if (textarea) textarea.value = "";

    currentPhotoId = null;
    commentsCursor = null;

    if (listEl) listEl.innerHTML = "";
    if (placeholder) {
      placeholder.style.display = "block";
      placeholder.textContent =
        "è¿™æ˜¯å…°æ˜Ÿå°‘å¹´ä¿±ä¹éƒ¨çš„ä¸€ä¸ªç¬é—´ã€‚å¦‚æœæœ‰å·²å®¡æ ¸é€šè¿‡çš„ç•™è¨€ï¼Œä¼šæ˜¾ç¤ºåœ¨ä¸‹é¢ã€‚";
    }
    if (loadMoreBtn) loadMoreBtn.style.display = "none";
  }


  window.closeModal = closeModal;

  // ---- æ‰“å¼€æ–°ç…§ç‰‡æ—¶é‡ç½®ç•™è¨€ UI ----
  function resetComments(photoId) {
    currentPhotoId = photoId;
    commentsCursor = null;

    const listEl = document.getElementById("commentList");
    const placeholder = document.getElementById("modalPlaceholderText");
    const loadMoreBtn = document.getElementById("commentLoadMoreBtn");

    if (listEl) listEl.innerHTML = "";
    if (placeholder) {
      placeholder.style.display = "block";
      placeholder.textContent = "æ­£åœ¨åŠ è½½ç•™è¨€â€¦";
    }
    if (loadMoreBtn) loadMoreBtn.style.display = "none";
  }

  // ---- ä» Worker æ‹‰å–ç•™è¨€ï¼ˆæ”¯æŒåˆ†é¡µï¼‰----
  async function loadComments(photoId, { append = false } = {}) {
    const listEl = document.getElementById("commentList");
    const placeholder = document.getElementById("modalPlaceholderText");
    const loadMoreBtn = document.getElementById("commentLoadMoreBtn");

    if (!listEl || !placeholder) return;
    if (!photoId || photoId !== currentPhotoId) return;
    if (isCommentsLoading) return;

    isCommentsLoading = true;
    try {
      let url = `${COMMENTS_API_BASE}/comments?photoId=${encodeURIComponent(photoId)}`;
      if (append && commentsCursor) {
        url += `&cursor=${encodeURIComponent(commentsCursor)}`;
      }

      const res = await fetch(url);
      if (!res.ok) throw new Error("åŠ è½½å¤±è´¥");
      const data = await res.json();
      const comments = Array.isArray(data.items) ? data.items : [];


      if (!append) {
        listEl.innerHTML = "";
      }

      if (comments.length === 0 && !append) {
        placeholder.style.display = "block";
        placeholder.textContent = "æš‚æ—¶è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¯ä»¥åšç¬¬ä¸€ä¸ªç•™è¨€çš„äººã€‚";
      } else if (comments.length > 0) {
        placeholder.style.display = "none";

        const frag = document.createDocumentFragment();
        comments.forEach(c => {
          const item = document.createElement("div");
          item.className = "comment-item";

          const region = c.region || "æŸåœ°";
          const created = c.createdAt
            ? new Date(c.createdAt).toLocaleDateString()
            : "";

          item.innerHTML = `
            <div class="comment-meta">
              <span class="comment-region">${escapeHtml(region)}</span>
              ${created ? `<span class="comment-date">${escapeHtml(created)}</span>` : ""}
            </div>
            <div class="comment-content">${escapeHtml(c.content)}</div>
          `;
          frag.appendChild(item);
        });
        listEl.appendChild(frag);
      }

      commentsCursor = data.cursor || null;
      if (loadMoreBtn) {
        loadMoreBtn.style.display = commentsCursor ? "inline-flex" : "none";
      }
    } catch (err) {
      console.error("åŠ è½½ç•™è¨€å¤±è´¥ï¼š", err);
      placeholder.style.display = "block";
      placeholder.textContent = "ç•™è¨€åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
    } finally {
      isCommentsLoading = false;
    }
  }

  // ---- Meta APIï¼ˆåŒåŸŸ Workerï¼š/media/meta?id=xxxï¼‰----
  const META_API_BASE = "/media";

  function resetMetaUI() {
    const loading = document.getElementById("metaLoadingText");
    const uploadedAtEl = document.getElementById("metaUploadedAt");
    const tagsEl = document.getElementById("metaTags");
    const captionEl = document.getElementById("metaCaption");

    if (loading) loading.style.display = "block";
    if (uploadedAtEl) uploadedAtEl.textContent = "-";
    if (tagsEl) tagsEl.textContent = "-";
    if (captionEl) captionEl.textContent = "-";
  }

  function renderTags(tags) {
    if (!Array.isArray(tags) || tags.length === 0) return "-";
    return tags
      .map(t => `<span class="meta-tag">${escapeHtml(t)}</span>`)
      .join(" ");
  }

  async function loadMeta(photoId) {
    const loading = document.getElementById("metaLoadingText");
    const uploadedAtEl = document.getElementById("metaUploadedAt");
    const tagsEl = document.getElementById("metaTags");
    const captionEl = document.getElementById("metaCaption");

    if (!photoId || photoId !== currentPhotoId) return;

    try {
      let url = `${META_API_BASE}/meta?id=${encodeURIComponent(photoId)}`;
      const res = await fetch(url);

      // å…è®¸ Not foundï¼šè¡¨ç¤ºè¿˜æ²¡å†™è¿‡ meta
      if (res.status === 404) {
        if (loading) loading.style.display = "none";
        if (uploadedAtEl) uploadedAtEl.textContent = "ï¼ˆæš‚æ— ï¼‰";
        if (tagsEl) tagsEl.innerHTML = "ï¼ˆæš‚æ— ï¼‰";
        if (captionEl) captionEl.textContent = "ï¼ˆæš‚æ— ï¼‰";
        return;
      }

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (loading) loading.style.display = "none";

      // uploadedAtï¼šç”¨â€œä¸Šä¼ æ—¶é—´æˆ³â€
      if (uploadedAtEl) {
        uploadedAtEl.textContent = data.uploadedAt
          ? new Date(data.uploadedAt).toLocaleString()
          : "ï¼ˆæš‚æ— ï¼‰";
      }

      // tagsï¼šå±•ç¤ºä¸ºå°èƒ¶å›Š
      if (tagsEl) {
        tagsEl.innerHTML = renderTags(data.tags);
      }

      // captionï¼šä¸€å¥è¯
      if (captionEl) {
        captionEl.textContent = data.caption ? String(data.caption) : "ï¼ˆæš‚æ— ï¼‰";
      }
    } catch (e) {
      console.error("åŠ è½½ meta å¤±è´¥ï¼š", e);
      if (loading) loading.style.display = "none";
      if (uploadedAtEl) uploadedAtEl.textContent = "ï¼ˆåŠ è½½å¤±è´¥ï¼‰";
      if (tagsEl) tagsEl.textContent = "ï¼ˆåŠ è½½å¤±è´¥ï¼‰";
      if (captionEl) captionEl.textContent = "ï¼ˆåŠ è½½å¤±è´¥ï¼‰";
    }
  }


  // ---- æäº¤ç•™è¨€ ----
  async function handleSubmitComment() {
  const textarea = document.getElementById("commentText");
  const btn = document.getElementById("commentSubmitBtn");
  if (!textarea || !btn || !currentPhotoId) return;

  const content = textarea.value.trim();
  if (!content) {
    alert("ç•™è¨€å†…å®¹ä¸èƒ½ä¸ºç©ºã€‚");
    return;
  }
  if (content.length < 4) {
    alert("å¯ä»¥å¤šå†™ä¸€ç‚¹ç‚¹å—ï¼Ÿè‡³å°‘ 4 ä¸ªå­—ã€‚");
    return;
  }
  if (content.length > 300) {
    alert("ç•™è¨€æœ‰ç‚¹é•¿äº†ï¼Œå¯ä»¥æ§åˆ¶åœ¨ 300 å­—ä»¥å†…å—ï¼Ÿ");
    return;
  }

  btn.disabled = true;
  const oldText = btn.textContent;
  btn.textContent = "å‘é€ä¸­â€¦";

  try {
    const payload = {
      photoId: String(currentPhotoId),
      
      content
    };

    console.log("å³å°†æäº¤ç•™è¨€ï¼š", payload);

    const res = await fetch(`${COMMENTS_API_BASE}/comments`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const rawText = await res.text(); // å…ˆæ‹¿åŸå§‹æ–‡æœ¬
    console.log("Worker è¿”å›åŸå§‹å“åº”ï¼š", res.status, rawText);

    let data = {};
    try {
      data = rawText ? JSON.parse(rawText) : {};
    } catch (e) {
      // ä¸æ˜¯ JSON ä¹Ÿæ²¡å…³ç³»ï¼Œä¸‹é¢ç»Ÿä¸€å¤„ç†
      console.warn("å“åº”ä¸æ˜¯ JSONï¼š", e);
    }

    if (!res.ok || !data.ok) {
      const msg =
        (data && (data.message || data.error)) ||
        rawText ||
        `HTTP ${res.status}`;
      throw new Error(msg);
    }

    textarea.value = "";
    alert("Thank you! Your message has been submitted.<br>It will appear after approval.");
  } catch (err) {
    console.error("æäº¤ç•™è¨€å¤±è´¥ï¼š", err);
    alert("æäº¤å¤±è´¥ï¼š" + (err && err.message ? err.message : "æœªçŸ¥é”™è¯¯"));
  } finally {
    btn.disabled = false;
    btn.textContent = oldText;
  }
}


  // ---- â€œåŠ è½½æ›´å¤šç•™è¨€â€æŒ‰é’® ----
  function handleLoadMoreComments() {
    if (!currentPhotoId || !commentsCursor) return;
    loadComments(currentPhotoId, { append: true });
  }


  /* ---------- åˆ†ç»„ï¼šå“ªäº›åš STACKï¼Œå“ªäº›æ•£è½ ---------- */
  function makeGroups(shuffled) {
    const stacks = [];
    const singles = [];
    const pool = shuffled.slice();
    const total = pool.length;

    if (total <= MIN_SINGLES) {
      while (pool.length > 0) singles.push(pool.shift());
      return { stacks, singles };
    }

    while (pool.length > 0) {
      const remaining     = pool.length;
      const singlesNeeded = Math.max(0, MIN_SINGLES - singles.length);
      const maxStackable  = remaining - singlesNeeded;

      if (maxStackable < 2) {
        singles.push(pool.shift());
        continue;
      }

      const r = Math.random();
      if (r < 0.30) {
        const stackSize = 2 + Math.floor(Math.random() * (maxStackable - 1));
        const group = pool.splice(0, stackSize);
        stacks.push(group);
      } else {
        singles.push(pool.shift());
      }
    }
    return { stacks, singles };
  }

  /* ---------- éšæœºä½ç½® ---------- */
  function randomPlacement(el) {
    const top   = 8 + Math.random() * 84;
    const left  = 8 + Math.random() * 84;
    const rot   = (Math.random() * 26 - 13).toFixed(1);
    const scale = 0.85 + Math.random() * 0.3;

    el.style.top  = top + "%";
    el.style.left = left + "%";
    el.style.transform = `translate(-50%, -50%) rotate(${rot}deg) scale(${scale})`;
    el.style.setProperty("--rot", `${rot}deg`);
  }

  /* ---------- æ‡’åŠ è½½ï¼šè¿›å…¥è§†å£é™„è¿‘å†åŠ è½½ç¼©ç•¥å›¾ ---------- */
  const lazyObserver = new IntersectionObserver(
    (entries, observer) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;
        const host = entry.target;
        const img = host.querySelector("img[data-src]");
        if (img && !img.src) {
          img.src = img.dataset.src;
        }
        observer.unobserve(host);
      });
    },
    {
      root: null,
      rootMargin: "200px",
      threshold: 0.1
    }
  );

  /* ---------- æ¸²æŸ“å•å¼  ---------- */
  function renderSinglePhoto(photo) {
    const card = document.createElement("div");
    card.className = "photo-card";
    card.dataset.photoId = photo.id;

    const inner = document.createElement("div");
    inner.className = "photo-card-inner";

    const frontImg = document.createElement("img");
    frontImg.className = "front-face";
    frontImg.alt = `Photo ${photo.id}`;
    frontImg.loading = "lazy";
    frontImg.dataset.src = photo.thumb;

    const back = document.createElement("div");
    back.className = "back-face";
    back.innerHTML = "<span>CLICK TO FLIP</span>";

    inner.appendChild(frontImg);
    inner.appendChild(back);
    card.appendChild(inner);

    if (Math.random() < 0.25) {
      card.classList.add("is-back");
    }

    card.addEventListener("click", () => {
      if (card.classList.contains("is-back")) {
        card.classList.remove("is-back");
      }
      openModal(photo);
    });

    randomPlacement(card);
    wall.appendChild(card);
    lazyObserver.observe(card);
  }

  /* ---------- æ¸²æŸ“å †å ï¼ˆåªåŠ è½½ 1 å¼ é¢„è§ˆç¼©ç•¥å›¾ï¼‰ ---------- */
  function renderStack(group, stackIndex) {
    const stack = document.createElement("div");
    stack.className = "photo-stack";
    stack.dataset.stackIndex = stackIndex;

    const inner = document.createElement("div");
    inner.className = "photo-stack-inner";

    const preview = group[Math.floor(Math.random() * group.length)];

    const cardBottom = document.createElement("div");
    cardBottom.className = "stack-card";
    cardBottom.style.background =
      "linear-gradient(135deg, #0f172a, #020617)";

    const cardMid = document.createElement("div");
    cardMid.className = "stack-card";
    cardMid.style.background =
      "linear-gradient(135deg, #1f2937, #020617)";

    const cardTop = document.createElement("div");
    cardTop.className = "stack-card";

    const img = document.createElement("img");
    img.alt = `Stack preview ${preview.id}`;
    img.loading = "lazy";
    img.dataset.src = preview.thumb;
    cardTop.appendChild(img);

    inner.appendChild(cardBottom);
    inner.appendChild(cardMid);
    inner.appendChild(cardTop);

    const size = group.length;
    const label = document.createElement("div");
    label.className = "stack-label";
    label.textContent = `STACK Â· ${size}`;

    const baseFont = 11;
    const font = baseFont + Math.min(size * 0.18, 7);
    label.style.fontSize = font + "px";
    const padY = 2 + Math.min(size * 0.06, 4);
    const padX = 6 + Math.min(size * 0.1, 6);
    label.style.padding = `${padY}px ${padX}px`;

    stack.appendChild(inner);
    stack.appendChild(label);

    stack.addEventListener("click", () => {
      const max = group.length;
      const input = prompt(
        `This stack holds ${max} photos.\n` +
        `Enter a number between 1 and ${max} to draw one:`
      );
      if (input === null) return;

      const n = parseInt(input, 10);
      if (Number.isNaN(n) || n < 1 || n > max) {
        alert(`Please enter a number between 1 and ${max}.`);
        return;
      }

      const picked = group[n - 1];
      openModal(picked);
    });

    randomPlacement(stack);
    wall.appendChild(stack);
    lazyObserver.observe(stack);
  }

  /* ---------- ä» list.json ç”Ÿæˆç…§ç‰‡å…ƒæ•°æ® ---------- */
  /* ---------- ä» list.json ç”Ÿæˆç…§ç‰‡å…ƒæ•°æ®ï¼ˆå…¼å®¹ v1 æ•°ç»„ / v2 å¯¹è±¡ï¼‰ ---------- */
function encodeFile(name) {
  // åªç¼–ç æ–‡ä»¶åéƒ¨åˆ†ï¼Œç¡®ä¿ç©ºæ ¼ã€æ‹¬å·ç­‰éƒ½å®‰å…¨
  return encodeURIComponent(String(name || ""));
}

function normalizeListJson(data) {
  // å…¼å®¹ï¼š
  // 1) ["HADO (1).jpg", ...]
  // 2) { items: [{id, file/name/filename, thumb, web, uploadedAt, tags, caption...}, ...] }
  if (Array.isArray(data)) {
    return data.map((file, index) => {
      const m = String(file).match(/\((\d+)\)/);
      const id = m ? parseInt(m[1], 10) : index + 1;
      const safe = String(file);
      return {
        id,
        file: safe,
        thumb: `/media/thumb/${encodeURIComponent(safe)}`,
        web: `/media/web/${encodeURIComponent(safe)}`
      };
    });
  }

  if (data && Array.isArray(data.items)) {
    return data.items
      .map((it, index) => {
        // âœ… å…³é”®ï¼šæŠŠ filename ä¹Ÿè®¤è¿›æ¥
        const file = it.file || it.name || it.filename || null;

        // idï¼šä¼˜å…ˆç”¨ it.idï¼Œå¦åˆ™ä»æ–‡ä»¶åæ‹¬å·é‡ŒæŠ½
        let id = Number.isFinite(it.id) ? it.id : null;
        if (id == null && file) {
          const m = String(file).match(/\((\d+)\)/);
          id = m ? parseInt(m[1], 10) : (index + 1);
        }
        if (id == null) id = index + 1;

        // âœ… å…³é”®ï¼šthumb/web ä¼˜å…ˆç”¨ worker ç»™çš„ï¼›æ²¡æœ‰å†æŒ‰ file å…œåº•æ‹¼
        const thumb = it.thumb || (file ? `/media/thumb/${encodeURIComponent(file)}` : null);
        const web = it.web || (file ? `/media/web/${encodeURIComponent(file)}` : null);

        // æ²¡æœ‰ä»»ä½•å¯ç”¨å›¾ç‰‡è·¯å¾„å°±ä¸¢å¼ƒ
        if (!thumb && !web) return null;

        return {
          id,
          file: file || null,
          filename: it.filename || file || null,
          thumb,
          web,
          uploadedAt: it.uploadedAt || null,
          tags: Array.isArray(it.tags) ? it.tags : null,
          caption: it.caption || null
        };
      })
      .filter(Boolean);
  }

  return [];
}

fetch("/media/list")
  .then(r => r.json())
  .then(data => {
    const items = normalizeListJson(data);

    const photos = items.map((it) => {
      const safe = encodeFile(it.file);
      return {
        id: it.id,
        name: it.file,
        uploadedAt: it.uploadedAt,
        tags: it.tags,
        caption: it.caption,

        // å…³é”®ï¼šè¿™é‡Œå¿…é¡»ç”¨ç¼–ç åçš„ safe
        thumb: `${THUMB_BASE}/${safe}`,
        full:  `${IMAGE_BASE}/${safe}`,
      };
    });

    const shuffled = photos.slice().sort(() => Math.random() - 0.5);
    const { stacks, singles } = makeGroups(shuffled);

    stacks.forEach((group, i) => renderStack(group, i));
    singles.forEach(photo => renderSinglePhoto(photo));
  })
  .catch(err => {
    console.error("åŠ è½½ /media/list å¤±è´¥ï¼š", err);
  });


  /* ---------- æµæ˜Ÿæ•ˆæœ ---------- */
  function launchMeteor() {
    const starLayer = document.querySelector(".shooting-star");
    if (!starLayer) return;

    const node = document.createElement("div");
    node.style.position = "absolute";
    node.style.width = "2px";
    node.style.height = "160px";
    node.style.background =
      "linear-gradient(white, rgba(255,255,255,0))";
    node.style.transform = "rotate(-45deg)";
    node.style.opacity = "0";
    node.style.animation = "meteor 1.8s ease-in-out forwards";

    const startX = Math.random() * window.innerWidth * 0.8;
    node.style.top = Math.random() * 200 + "px";
    node.style.left = startX + "px";

    starLayer.appendChild(node);
    setTimeout(() => starLayer.removeChild(node), 2000);

    const next = Math.random() * 15000 + 5000;
    setTimeout(launchMeteor, next);
  }
  setTimeout(launchMeteor, 3000);

// ç»‘å®šç•™è¨€ç›¸å…³æŒ‰é’®
  const submitBtn = document.getElementById("commentSubmitBtn");
  if (submitBtn) submitBtn.addEventListener("click", handleSubmitComment);

  const loadMoreBtn = document.getElementById("commentLoadMoreBtn");
  if (loadMoreBtn) loadMoreBtn.addEventListener("click", handleLoadMoreComments);
});
</script>

<!-- æ¨¡æ€æ¡† -->
<div class="modal" id="photoModal">
  <div class="modal-inner">
    <div class="modal-image-wrap">
      <img id="modalImage" src="" alt="Photo preview" />
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-info">
  <!-- PHOTO -->
  <div>
    <div class="modal-meta-label">PHOTO</div>
    <div class="modal-photo-id" id="modalPhotoId"></div>
  </div>

  <!-- METAï¼ˆæ–°å¢ï¼‰ -->
  <div class="modal-meta-box" id="modalMetaBox">
    <div class="modal-meta-label">META</div>
    <div id="metaLoadingText" class="meta-muted">ç‚¹å¼€ç…§ç‰‡ååŠ è½½ä¸­â€¦</div>

    <div class="meta-row">
      <span class="meta-k">ä¸Šä¼ æ—¶é—´</span>
      <span class="meta-v" id="metaUploadedAt">-</span>
    </div>

    <div class="meta-row">
      <span class="meta-k">åˆ†ç±»æ ‡ç­¾</span>
      <span class="meta-v" id="metaTags">-</span>
    </div>

    <div class="meta-row">
      <span class="meta-k">ä¸€å¥è¯</span>
      <span class="meta-v" id="metaCaption">-</span>
    </div>
  </div>

  <!-- NOTESï¼ˆç•™è¨€å±•ç¤ºï¼‰ -->
  <div>
    <div class="modal-meta-label">NOTES</div>
    <p id="modalPlaceholderText" class="comment-placeholder">
      è¿™æ˜¯å…°æ˜Ÿå°‘å¹´ä¿±ä¹éƒ¨çš„ä¸€ä¸ªç¬é—´ã€‚å¦‚æœæœ‰å·²å®¡æ ¸é€šè¿‡çš„ç•™è¨€ï¼Œä¼šæ˜¾ç¤ºåœ¨ä¸‹é¢ã€‚
    </p>
    <div id="commentList" class="comment-list"></div>
    <button id="commentLoadMoreBtn" class="comment-load-more" style="display:none;">
      åŠ è½½æ›´å¤šç•™è¨€
    </button>
  </div>

  <!-- ç•™è¨€æäº¤ -->
  <div class="comment-box">
    <div class="modal-meta-label">LEAVE A MESSAGE</div>
    <textarea id="commentText"
      placeholder="å†™ä¸€å¥å…³äºè¿™å¼ ç…§ç‰‡çš„å°ç•™è¨€ï¼ˆ20~120 å­—ä¸ºå®œï¼‰ã€‚"></textarea>
    <button id="commentSubmitBtn">å‘é€ç•™è¨€</button>
    <div class="comment-hint">
      æäº¤åç•™è¨€ä¼šè¿›å…¥å®¡æ ¸é˜Ÿåˆ—ã€‚é€šè¿‡å®¡æ ¸åæ‰ä¼šåœ¨è¿™é‡Œæ˜¾ç¤ºï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚
    </div>
  </div>
</div>

  </div>
</div>
</body>
</html>
