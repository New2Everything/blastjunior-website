<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…°æ˜Ÿå°‘å¹´ä¿±ä¹éƒ¨ Â· ç…§ç‰‡å®‡å®™</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
<header>
  <div class="container nav">
    <div class="nav-left">
      <div class="nav-logo">L</div>
      <div>å…°æ˜Ÿå°‘å¹´ä¿±ä¹éƒ¨ Â· ç…§ç‰‡å®‡å®™</div>
    </div>
    <a href="index.html">è¿”å›é¦–é¡µ</a>
  </div>
</header>

<main>
  <div class="container">
    <div class="intro-card">
      <h1>å…°æ˜Ÿå°‘å¹´ Â· ç…§ç‰‡å®‡å®™</h1>
      <p class="subtitle-small">
        å¦‚æœæŸå¼ ç…§ç‰‡è®©ä½ æƒ³èµ·æœ‰è¶£çš„æ•…äº‹ã€æ¯”èµ›çš„é‚£ä¸€ç§’ã€æŸä¸ªå­©å­çš„é—ªå…‰ç‚¹ï¼Œ
        æ¬¢è¿åœ¨ç…§ç‰‡ä¸‹æ–¹ç•™è¨€ï¼Œä¸€èµ·æŠŠè¿™ç‰‡ç…§ç‰‡å®‡å®™â€œè£…ä¿®â€å¾—æ›´çƒ­é—¹ã€æ›´æœ‰æ¸©åº¦ã€‚
      </p>

      <div class="notice">
        <p style="margin-bottom: 4px;"><strong>ğŸ“Œ æ¸©é¦¨æç¤ºï¼ˆä¸­æ–‡ï¼‰</strong><br>
          å¦‚æœä½ å‘ç°æŸå¼ ç…§ç‰‡ä¸é€‚åˆå…¬å¼€å±•ç¤ºï¼Œè¯·åœ¨è¯¥ç…§ç‰‡ç•™è¨€å¤„ç•™è¨€æˆ–é‚®ä»¶è”ç³»æˆ‘ä»¬ï¼š
          <a href="mailto:blastjunior@163.com">blastjunior@163.com</a>ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†å¹¶ä¸‹æ¶ã€‚
        </p>

        <p style="margin-bottom: 4px;"><strong>ğŸ“Œ Friendly Notice (English)</strong><br>
          If you find a photo that you believe should not be displayed,
          please leave a message under that photo or contact us at
          <a href="mailto:blastjunior@163.com">blastjunior@163.com</a>.
          We will review and remove it as soon as possible.
        </p>

        <p style="margin-bottom: 4px;"><strong>ğŸ“Œ ã”é€£çµ¡ãã ã•ã„ï¼ˆæ—¥æœ¬èªï¼‰</strong><br>
          å…¬é–‹ã«ä¸é©åˆ‡ã¨æ€ã‚ã‚Œã‚‹å†™çœŸãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ãã®å†™çœŸã®ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ®‹ã™ã‹ã€
          <a href="mailto:blastjunior@163.com">blastjunior@163.com</a> ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚
          ç¢ºèªå¾Œã€é€Ÿã‚„ã‹ã«å‰Šé™¤ã„ãŸã—ã¾ã™ã€‚
        </p>

        <p style="margin-bottom: 0;"><strong>ğŸ“Œ ì•ˆë‚´ë¬¸ (í•œêµ­ì–´)</strong><br>
          ê³µê°œë˜ê¸° ì–´ë ¤ìš´ ì‚¬ì§„ì„ ë°œê²¬í•˜ì‹œë©´, í•´ë‹¹ ì‚¬ì§„ì˜ ëŒ“ê¸€ì— ë‚¨ê²¨ì£¼ì‹œê±°ë‚˜
          <a href="mailto:blastjunior@163.com">blastjunior@163.com</a> ìœ¼ë¡œ ì—°ë½ì£¼ì„¸ìš”.
          í™•ì¸ í›„ ì‹ ì†íˆ ì‚­ì œí•˜ê² ìŠµë‹ˆë‹¤.
        </p>
      </div>
    </div>

    <div class="universe-bg">
      <div class="stars"></div>
      <div class="shooting-star"></div>

      <div class="floating-wrapper">
        <div class="floating-wall" id="floatingWall">
          <!-- JS ä¼šåœ¨è¿™é‡Œç”Ÿæˆéšæœºæ•£è½ / å †å çš„ç…§ç‰‡ -->
        </div>
      </div>
    </div>
  </div>
</main>

<div class="footer-nav">
  <a href="index.html">é¦–é¡µ</a>
  <a href="honor.html">è£èª‰å®¤</a>
  <a href="gallery.html">ç…§ç‰‡å¢™</a>
  <a href="news.html">æ–°é—»ä¸­å¿ƒ</a>
</div>

<footer>
  Â© <script>document.write(new Date().getFullYear())</script> å…°æ˜Ÿå°‘å¹´ä¿±ä¹éƒ¨ Â· Photo Wall
</footer>

<!-- ç…§ç‰‡å®‡å®™è„šæœ¬ï¼ˆç¼©ç•¥å›¾ + å»¶è¿ŸåŠ è½½åŸå›¾ï¼‰ -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const wall = document.getElementById("floatingWall");
  if (!wall) return;

  const IMAGE_BASE = "/images";
  const THUMB_BASE = "/images/thumbs";
  const MIN_SINGLES = 30;

  /* ---------- æŠ˜å å±å‹å¥½çš„å¯è§†é«˜åº¦ ---------- */
  function getViewportHeight() {
    if (window.visualViewport && window.visualViewport.height) {
      return window.visualViewport.height;
    }
    return window.innerHeight || document.documentElement.clientHeight || 800;
  }

  /* ---------- æ¨¡æ€æ¡†æ‰“å¼€ / å…³é—­ ---------- */
  function openModal(photo) {
    const modal = document.getElementById("photoModal");
    const img   = document.getElementById("modalImage");
    const idSpan = document.getElementById("modalPhotoId");

    if (!modal || !img || !idSpan) return;

    // å›ºå®šç¼–å·ï¼šç›´æ¥ç”¨ photo.idï¼ˆæ¥è‡ªæ–‡ä»¶åï¼‰
    idSpan.textContent = `#${String(photo.id).padStart(3, "0")}`;

    // æ¸…ç©ºæ—§å›¾ï¼Œé¿å…é—ªçƒ
    img.src = "";
    modal.classList.add("visible");

    const vh = getViewportHeight();
    const modalInner = modal.querySelector(".modal-inner");
    if (modalInner) {
      modalInner.style.maxHeight = Math.round(vh * 0.9) + "px";
    }
    img.style.maxHeight = Math.round(vh * 0.55) + "px";

    img.src = photo.full || photo.src;
  }

  function closeModal() {
    const modal = document.getElementById("photoModal");
    const img   = document.getElementById("modalImage");
    const textarea = document.getElementById("commentText");

    if (modal) modal.classList.remove("visible");
    if (img) img.src = "";
    if (textarea) textarea.value = "";
  }

  window.closeModal = closeModal;

  /* ---------- åˆ†ç»„ï¼šå“ªäº›åš STACKï¼Œå“ªäº›æ•£è½ ---------- */
  function makeGroups(shuffled) {
    const stacks = [];
    const singles = [];
    const pool = shuffled.slice();
    const total = pool.length;

    if (total <= MIN_SINGLES) {
      while (pool.length > 0) singles.push(pool.shift());
      return { stacks, singles };
    }

    while (pool.length > 0) {
      const remaining     = pool.length;
      const singlesNeeded = Math.max(0, MIN_SINGLES - singles.length);
      const maxStackable  = remaining - singlesNeeded;

      if (maxStackable < 2) {
        singles.push(pool.shift());
        continue;
      }

      const r = Math.random();
      if (r < 0.30) {
        const stackSize = 2 + Math.floor(Math.random() * (maxStackable - 1));
        const group = pool.splice(0, stackSize);
        stacks.push(group);
      } else {
        singles.push(pool.shift());
      }
    }
    return { stacks, singles };
  }

  /* ---------- éšæœºä½ç½® ---------- */
  function randomPlacement(el) {
    const top   = 8 + Math.random() * 84;
    const left  = 8 + Math.random() * 84;
    const rot   = (Math.random() * 26 - 13).toFixed(1);
    const scale = 0.85 + Math.random() * 0.3;

    el.style.top  = top + "%";
    el.style.left = left + "%";
    el.style.transform = `translate(-50%, -50%) rotate(${rot}deg) scale(${scale})`;
    el.style.setProperty("--rot", `${rot}deg`);
  }

  /* ---------- æ‡’åŠ è½½ï¼šè¿›å…¥è§†å£é™„è¿‘å†åŠ è½½ç¼©ç•¥å›¾ ---------- */
  const lazyObserver = new IntersectionObserver(
    (entries, observer) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;
        const host = entry.target;
        const img = host.querySelector("img[data-src]");
        if (img && !img.src) {
          img.src = img.dataset.src;
        }
        observer.unobserve(host);
      });
    },
    {
      root: null,
      rootMargin: "200px",
      threshold: 0.1
    }
  );

  /* ---------- æ¸²æŸ“å•å¼  ---------- */
  function renderSinglePhoto(photo) {
    const card = document.createElement("div");
    card.className = "photo-card";
    card.dataset.photoId = photo.id;

    const inner = document.createElement("div");
    inner.className = "photo-card-inner";

    const frontImg = document.createElement("img");
    frontImg.className = "front-face";
    frontImg.alt = `Photo ${photo.id}`;
    frontImg.loading = "lazy";
    frontImg.dataset.src = photo.thumb;

    const back = document.createElement("div");
    back.className = "back-face";
    back.innerHTML = "<span>CLICK TO FLIP</span>";

    inner.appendChild(frontImg);
    inner.appendChild(back);
    card.appendChild(inner);

    if (Math.random() < 0.25) {
      card.classList.add("is-back");
    }

    card.addEventListener("click", () => {
      if (card.classList.contains("is-back")) {
        card.classList.remove("is-back");
      }
      openModal(photo);
    });

    randomPlacement(card);
    wall.appendChild(card);
    lazyObserver.observe(card);
  }

  /* ---------- æ¸²æŸ“å †å ï¼ˆåªåŠ è½½ 1 å¼ é¢„è§ˆç¼©ç•¥å›¾ï¼‰ ---------- */
  function renderStack(group, stackIndex) {
    const stack = document.createElement("div");
    stack.className = "photo-stack";
    stack.dataset.stackIndex = stackIndex;

    const inner = document.createElement("div");
    inner.className = "photo-stack-inner";

    const preview = group[Math.floor(Math.random() * group.length)];

    const cardBottom = document.createElement("div");
    cardBottom.className = "stack-card";
    cardBottom.style.background =
      "linear-gradient(135deg, #0f172a, #020617)";

    const cardMid = document.createElement("div");
    cardMid.className = "stack-card";
    cardMid.style.background =
      "linear-gradient(135deg, #1f2937, #020617)";

    const cardTop = document.createElement("div");
    cardTop.className = "stack-card";

    const img = document.createElement("img");
    img.alt = `Stack preview ${preview.id}`;
    img.loading = "lazy";
    img.dataset.src = preview.thumb;
    cardTop.appendChild(img);

    inner.appendChild(cardBottom);
    inner.appendChild(cardMid);
    inner.appendChild(cardTop);

    const size = group.length;
    const label = document.createElement("div");
    label.className = "stack-label";
    label.textContent = `STACK Â· ${size}`;

    const baseFont = 11;
    const font = baseFont + Math.min(size * 0.18, 7);
    label.style.fontSize = font + "px";
    const padY = 2 + Math.min(size * 0.06, 4);
    const padX = 6 + Math.min(size * 0.1, 6);
    label.style.padding = `${padY}px ${padX}px`;

    stack.appendChild(inner);
    stack.appendChild(label);

    stack.addEventListener("click", () => {
      const max = group.length;
      const input = prompt(
        `This stack holds ${max} photos.\n` +
        `Enter a number between 1 and ${max} to draw one:`
      );
      if (input === null) return;

      const n = parseInt(input, 10);
      if (Number.isNaN(n) || n < 1 || n > max) {
        alert(`Please enter a number between 1 and ${max}.`);
        return;
      }

      const picked = group[n - 1];
      openModal(picked);
    });

    randomPlacement(stack);
    wall.appendChild(stack);
    lazyObserver.observe(stack);
  }

  /* ---------- ä» list.json ç”Ÿæˆç…§ç‰‡å…ƒæ•°æ® ---------- */
  fetch("/images/list.json")
    .then(r => r.json())
    .then(files => {
      const photos = files.map((name, index) => {
        // ä»æ–‡ä»¶åä¸­æŠ½å– (123) è¿™æ ·çš„æ•°å­—ä½œä¸ºç¨³å®š ID
        const m = name.match(/\((\d+)\)/);
        const id = m ? parseInt(m[1], 10) : index + 1;
        return {
          id,
          name,
          thumb: `${THUMB_BASE}/${name}`,
          full:  `${IMAGE_BASE}/${name}`,
        };
      });

      const shuffled = photos.slice().sort(() => Math.random() - 0.5);
      const { stacks, singles } = makeGroups(shuffled);

      stacks.forEach((group, i) => renderStack(group, i));
      singles.forEach(photo => renderSinglePhoto(photo));
    })
    .catch(err => {
      console.error("åŠ è½½ /images/list.json å¤±è´¥ï¼š", err);
    });

  /* ---------- æµæ˜Ÿæ•ˆæœ ---------- */
  function launchMeteor() {
    const starLayer = document.querySelector(".shooting-star");
    if (!starLayer) return;

    const node = document.createElement("div");
    node.style.position = "absolute";
    node.style.width = "2px";
    node.style.height = "160px";
    node.style.background =
      "linear-gradient(white, rgba(255,255,255,0))";
    node.style.transform = "rotate(-45deg)";
    node.style.opacity = "0";
    node.style.animation = "meteor 1.8s ease-in-out forwards";

    const startX = Math.random() * window.innerWidth * 0.8;
    node.style.top = Math.random() * 200 + "px";
    node.style.left = startX + "px";

    starLayer.appendChild(node);
    setTimeout(() => starLayer.removeChild(node), 2000);

    const next = Math.random() * 15000 + 5000;
    setTimeout(launchMeteor, next);
  }
  setTimeout(launchMeteor, 3000);
});
</script>

<!-- æ¨¡æ€æ¡† -->
<div class="modal" id="photoModal">
  <div class="modal-inner">
    <div class="modal-image-wrap">
      <img id="modalImage" src="" alt="Photo preview" />
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-info">
      <div>
        <div class="modal-meta-label">PHOTO</div>
        <div class="modal-photo-id" id="modalPhotoId"></div>
      </div>
      <div>
        <div class="modal-meta-label">NOTES</div>
        <p id="modalPlaceholderText">
          è¿™æ˜¯å…°æ˜Ÿå°‘å¹´ä¿±ä¹éƒ¨çš„ä¸€ä¸ªç¬é—´ã€‚æœªæ¥è¿™é‡Œä¼šæ˜¾ç¤ºå·²å®¡æ ¸é€šè¿‡çš„ç•™è¨€èŠ‚é€‰ã€‚
        </p>
      </div>
      <div class="comment-box">
        <div class="modal-meta-label">LEAVE A MESSAGE</div>
        <textarea id="commentText"
          placeholder="Write a short message about this photo..."></textarea>
        <button id="commentSubmitBtn"
          onclick="alert('ç›®å‰ä¸ºæ¼”ç¤ºç‰ˆï¼Œæœªæ¥ä¼šæ¥å…¥ Cloudflare Worker è¿›è¡Œç•™è¨€å®¡æ ¸ä¸ä¿å­˜ã€‚');">
          Send (demo)
        </button>
        <div class="comment-hint">
          Demo ç‰ˆæœ¬ï¼šæš‚æ—¶ä¸ä¼šçœŸæ­£ä¿å­˜ç•™è¨€ã€‚æ­£å¼ç‰ˆä¼šé€šè¿‡ Cloudflare KV å­˜å‚¨å¹¶äººå·¥å®¡æ ¸åå±•ç¤ºã€‚
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>
